{% extends 'base.html' %} {% block title %}数据可视化 - 豆粕期货价格预测系统{%
endblock %} {% block head %}
<!-- 引入 jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- 引入 Chart.js 和其他需要的库 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
<style>
  .chart-container {
    position: relative;
    height: 400px;
    margin-bottom: 30px;
  }
  .data-card {
    transition: all 0.3s ease;
  }
  .data-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  }
  .data-controls {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
  }
  .prediction-badge {
    font-size: 1.2rem;
    padding: 8px 15px;
  }
  /* 表格行样式 - 已移除悬停和点击效果 */
  .table-row-hover {
    transition: all 0.2s ease;
  }
</style>
{% endblock %} {% block content %}
<div class="container">
  <div class="row mb-4">
    <div class="col-md-12">
      <h2><i class="bi bi-bar-chart"></i> 豆粕期货数据分析</h2>
      <p class="lead">通过深度学习模型分析历史数据，预测未来价格走势</p>
    </div>
  </div>

  <!-- 数据控制面板 -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card data-controls">
        <div class="card-body">
          <div class="row">
            <div class="col-md-8">
              <label for="modelSelect" class="form-label">预测模型</label>
              <select class="form-select" id="modelSelect">
                <option value="mlp" selected>MLP模型</option>
                <option value="lstm">LSTM模型</option>
                <option value="cnn">CNN模型</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">&nbsp;</label>
              <button class="btn btn-primary w-100" id="applyFiltersBtn">
                <i class="bi bi-funnel"></i> 预测
              </button>
            </div>
            <!-- 隐藏的元素，保持JavaScript功能正常 -->
            <div style="display: none">
              <select id="timeRangeSelect">
                <option value="30" selected>最近一个月</option>
              </select>
              <select id="predictionRange">
                <option value="1" selected>1天</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 价格预测卡片 -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card data-card bg-light">
        <div class="card-body text-center">
          <h5 class="card-title">当前价格</h5>
          <h2 class="display-5 fw-bold">3,456.00</h2>
          <p class="text-success">
            <i class="bi bi-arrow-up"></i> +2.5% (今日)
          </p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card data-card bg-light">
        <div class="card-body text-center">
          <h5 class="card-title" id="prediction-title">预测收盘价 (明日)</h5>
          <div id="prediction-loading" class="text-center py-2">
            <div
              class="spinner-border spinner-border-sm text-primary"
              role="status"
            >
              <span class="visually-hidden">加载中...</span>
            </div>
            <span class="ms-2">正在预测...</span>
          </div>
          <div id="prediction-content" style="display: none">
            <h2 class="display-5 fw-bold" id="predicted-price">--</h2>
            <p class="text-muted" id="predicted-change">
              <i class="bi bi-dash"></i> --% (预期)
            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card data-card bg-light">
        <div class="card-body text-center">
          <h5 class="card-title">模型准确率</h5>
          <div class="progress mb-3" style="height: 25px">
            <div
              id="model-accuracy-bar"
              class="progress-bar bg-success"
              role="progressbar"
              style="width: 0%"
              aria-valuenow="0"
              aria-valuemin="0"
              aria-valuemax="100"
            >
              0%
            </div>
          </div>
          <p class="text-muted" id="model-description">加载中...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- 主图表 -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-graph-up"></i> 豆粕期货价格走势与预测
          </h5>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <div id="chartLoadingIndicator" class="text-center p-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
              </div>
              <p class="mt-3">正在加载图表数据...</p>
            </div>
            <canvas id="closingPriceChart" style="display: none"></canvas>
          </div>
          <div class="d-flex justify-content-center mt-3">
            <div class="btn-group" role="group">
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                id="zoomInBtn"
              >
                <i class="bi bi-zoom-in"></i> 放大
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                id="zoomOutBtn"
              >
                <i class="bi bi-zoom-out"></i> 缩小
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                id="resetZoomBtn"
              >
                <i class="bi bi-arrow-counterclockwise"></i> 重置
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 成交量图表 -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-bar-chart"></i> 成交量</h5>
        </div>
        <div class="card-body">
          <div class="chart-container" style="height: 200px">
            <canvas id="volumeChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 技术指标面板 -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-graph-up"></i> RSI_14指标</h5>
        </div>
        <div class="card-body">
          <div class="chart-container" style="height: 250px">
            <canvas id="rsiChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-graph-up"></i> HV_20与ATR_14指标</h5>
        </div>
        <div class="card-body">
          <div class="chart-container" style="height: 250px">
            <canvas id="volatilityChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MACD指标和OBV指标 -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-graph-up"></i> MACD指标</h5>
        </div>
        <div class="card-body">
          <div class="chart-container" style="height: 250px">
            <canvas id="macdChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-graph-up"></i> OBV指标</h5>
        </div>
        <div class="card-body">
          <div class="chart-container" style="height: 250px">
            <canvas id="obvChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 最高价和最低价、大豆价格和玉米价格 -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-graph-up"></i> 最高价和最低价</h5>
        </div>
        <div class="card-body">
          <div class="chart-container" style="height: 250px">
            <canvas id="highLowChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-graph-up"></i> 大豆价格和玉米价格
          </h5>
        </div>
        <div class="card-body">
          <div class="chart-container" style="height: 250px">
            <canvas id="acCloseChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 数据表格和其他指标 -->
  <div class="row">
    <div class="col-md-8">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-table"></i> 历史数据</h5>
        </div>
        <div class="card-body">
          <!-- 添加时间区间查询表单 -->
          <div class="row mb-3">
            <div class="col-md-10">
              <div class="row g-2">
                <div class="col-md-5">
                  <div class="input-group">
                    <span class="input-group-text">开始日期</span>
                    <input type="date" class="form-control" id="startDate" />
                  </div>
                </div>
                <div class="col-md-5">
                  <div class="input-group">
                    <span class="input-group-text">结束日期</span>
                    <input type="date" class="form-control" id="endDate" />
                  </div>
                </div>
                <div class="col-md-2">
                  <button class="btn btn-primary w-100" id="queryDateRangeBtn">
                    查询
                  </button>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <button
                class="btn btn-outline-secondary w-100"
                id="resetDateRangeBtn"
              >
                重置
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped table-hover" id="dataTable">
              <thead>
                <tr>
                  <th>日期</th>
                  <th>开盘价</th>
                  <th>最高价</th>
                  <th>最低价</th>
                  <th>收盘价</th>
                  <th>成交量</th>
                  <th>涨跌幅</th>
                </tr>
              </thead>
              <tbody>
                <!-- 表格内容将由JavaScript动态生成 -->
              </tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <span class="text-muted" id="dataCountDisplay">只显示前5条</span>
            </div>
            <nav>
              <ul class="pagination pagination-sm">
                <li class="page-item disabled">
                  <a class="page-link" href="#">上一页</a>
                </li>
                <li class="page-item active">
                  <a class="page-link" href="#">1</a>
                </li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item">
                  <a class="page-link" href="#">下一页</a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-gear"></i> 数据管理</h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            {% if session.user_role == 'admin' %}
            <button
              class="btn btn-outline-primary mb-3"
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#uploadDataModal"
            >
              <i class="bi bi-upload"></i> 上传新数据
            </button>
            <button
              class="btn btn-outline-primary mb-3"
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#appendDataModal"
            >
              <i class="bi bi-file-earmark-plus"></i> 增加数据文件
            </button>
            <button
              class="btn btn-outline-primary mb-3"
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#editDataModal"
            >
              <i class="bi bi-pencil"></i> 编辑数据
            </button>
            <button
              class="btn btn-outline-danger"
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#deleteDataModal"
            >
              <i class="bi bi-trash"></i> 删除数据
            </button>
            {% else %}
            <div class="alert alert-secondary">
              <i class="bi bi-lock"></i> 数据管理功能仅对管理员开放
            </div>
            {% endif %}
          </div>

          <hr class="my-4" />

          <div class="alert alert-info">
            <h6><i class="bi bi-info-circle"></i> 数据说明</h6>
            <p class="mb-0">
              本系统使用深度学习模型分析豆粕期货历史数据，预测未来价格走势。预测结果仅供参考，不构成投资建议。
            </p>
          </div>

          <div class="alert alert-warning">
            <h6><i class="bi bi-exclamation-triangle"></i> 风险提示</h6>
            <p class="mb-0">
              期货交易有风险，投资需谨慎。历史数据不代表未来表现，请结合多种因素进行分析决策。
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 上传数据模态框 -->
<div
  class="modal fade"
  id="uploadDataModal"
  tabindex="-1"
  aria-labelledby="uploadDataModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="uploadDataModalLabel">上传新数据</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="uploadDataForm" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="dataFile" class="form-label">选择CSV文件</label>
            <input
              class="form-control"
              type="file"
              id="dataFile"
              name="file"
              accept=".csv"
              required
            />
            <div class="form-text">
              请上传包含日期、开盘价、最高价、最低价、收盘价、成交量等列的CSV文件
            </div>
          </div>

          <div class="alert alert-info">
            <small
              >上传后系统将自动处理数据，添加技术指标，并使用新上传的数据进行趋势图显示和预测分析。</small
            >
          </div>
          <div id="uploadStatus" class="d-none">
            <div class="progress mb-3">
              <div
                id="uploadProgressBar"
                class="progress-bar progress-bar-striped progress-bar-animated"
                role="progressbar"
                style="width: 0%"
              ></div>
            </div>
            <p id="uploadStatusText" class="text-center"></p>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          取消
        </button>
        <button type="button" class="btn btn-primary" id="uploadDataBtn">
          上传
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 编辑数据模态框 -->
<div
  class="modal fade"
  id="editDataModal"
  tabindex="-1"
  aria-labelledby="editDataModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editDataModalLabel">编辑数据</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label for="editDate" class="form-label">日期</label>
            <input type="date" class="form-control" id="editDate" />
          </div>
          <div class="mb-3">
            <label for="editOpen" class="form-label">开盘价</label>
            <input
              type="number"
              class="form-control"
              id="editOpen"
              step="0.01"
            />
          </div>
          <div class="mb-3">
            <label for="editHigh" class="form-label">最高价</label>
            <input
              type="number"
              class="form-control"
              id="editHigh"
              step="0.01"
            />
          </div>
          <div class="mb-3">
            <label for="editLow" class="form-label">最低价</label>
            <input
              type="number"
              class="form-control"
              id="editLow"
              step="0.01"
            />
          </div>
          <div class="mb-3">
            <label for="editClose" class="form-label">收盘价</label>
            <input
              type="number"
              class="form-control"
              id="editClose"
              step="0.01"
            />
          </div>
          <div class="mb-3">
            <label for="editVolume" class="form-label">成交量</label>
            <input type="number" class="form-control" id="editVolume" />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          取消
        </button>
        <button type="button" class="btn btn-primary" id="saveEditBtn">
          保存
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 增加数据模态框 -->
<div
  class="modal fade"
  id="appendDataModal"
  tabindex="-1"
  aria-labelledby="appendDataModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="appendDataModalLabel">增加数据</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="appendDataForm" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="appendDataFile" class="form-label">选择CSV文件</label>
            <input
              class="form-control"
              type="file"
              id="appendDataFile"
              name="file"
              accept=".csv"
              required
            />
            <div class="form-text">
              请上传包含日期、开盘价、最高价、最低价、收盘价、成交量等列的CSV文件
            </div>
          </div>
          <div class="alert alert-info">
            <small
              >上传后系统将自动处理数据，并将新数据添加到现有数据集中。添加的数据将用于趋势图显示和预测分析。</small
            >
          </div>
          <div id="appendStatus" class="d-none">
            <div class="progress mb-3">
              <div
                id="appendProgressBar"
                class="progress-bar progress-bar-striped progress-bar-animated"
                role="progressbar"
                style="width: 0%"
              ></div>
            </div>
            <p id="appendStatusText" class="text-center"></p>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          取消
        </button>
        <button type="button" class="btn btn-primary" id="appendDataBtn">
          增加
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 删除数据模态框 -->
<div
  class="modal fade"
  id="deleteDataModal"
  tabindex="-1"
  aria-labelledby="deleteDataModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteDataModalLabel">删除数据</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label for="deleteDate" class="form-label">删除日期</label>
            <input type="date" class="form-control" id="deleteDate" />
          </div>
          <div class="alert alert-danger">
            警告：删除操作不可恢复，此操作将删除所选日期的数据。
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          取消
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          删除
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  // 从 Flask 模板获取数据
  let chartData, labels, closingPrices;
  let modelMetrics = {{ model_metrics | safe }};
  let DATA_FILE_PATH = "{{ data_path | safe }}";

  // 记录初始数据源信息
  // console.log("初始数据源:", DATA_FILE_PATH);

  // 调试输出模型指标
  // console.log('模型指标:', modelMetrics);

  try {
      // 检查 chart_data 是否已经是对象
      const rawData = {{ chart_data | safe }};
      console.log("原始数据类型:", typeof rawData);

      // 如果是字符串，则解析为JSON；如果已经是对象，则直接使用
      chartData = typeof rawData === 'string' ? JSON.parse(rawData) : rawData;
      console.log("加载的图表数据:", chartData);

      // 输出数据集总数
      if (chartData && chartData.labels) {
          console.log("数据集总条数:", chartData.labels.length);
      } else {
          console.warn("无法获取数据集总条数，chartData.labels不存在");
      }

      // 检查数据是否有效
      if (chartData && chartData.labels && chartData.closing_prices) {
          labels = chartData.labels;
          closingPrices = chartData.closing_prices;

          // 显示数据加载成功消息
          // console.log(`成功加载数据: ${labels.length} 条记录`);

          // 更新表格中的实际数据
          updateDataTable(chartData);
      } else if (chartData && chartData.error) {
          // 显示错误消息
          // console.error("数据加载错误:", chartData.error);
          alert("数据加载错误: " + chartData.error);

          // 使用空数组作为默认值
          labels = [];
          closingPrices = [];
      } else {
          // console.error("数据格式无效");
          alert("数据格式无效，无法显示图表");

          // 使用空数组作为默认值
          labels = [];
          closingPrices = [];
      }
  } catch (e) {
      // console.error("解析数据时出错:", e);
      alert("解析数据时出错: " + e.message);

      // 使用空数组作为默认值
      labels = [];
      closingPrices = [];
  }

  // 如果没有数据，使用示例数据进行演示
  if (!labels || labels.length === 0) {
      labels = ['2023-04-25', '2023-04-26', '2023-04-27', '2023-04-28', '2023-04-29', '2023-04-30', '2023-05-01', '2023-05-02', '2023-05-03'];
      closingPrices = [3350, 3370, 3380, 3390, 3400, 3390, 3380, 3420, 3456];
      // console.log("使用示例数据进行演示");
  }

  // 预测数据变量
  let predictionLabels = [];
  let predictionPrices = [];
  let currentModel = 'mlp';
  let isLoading = false;

  // 函数：调用后端API进行预测
  async function fetchPrediction(model, days) {
      // 显示加载状态
      isLoading = true;
      showLoadingState(true);
      console.log(`Fetching prediction for model: ${model}, days: ${days}`);

      try {
          // 添加时间戳参数，确保不使用缓存的响应
          const timestamp = new Date().getTime();
          const apiUrl = `/viz/api/predict?model=${model}&days=${days}&_t=${timestamp}`;
          console.log(`发送预测请求到: ${apiUrl}`);

          // 使用 no-cache 和 no-store 确保不使用缓存
          const response = await fetch(apiUrl, {
              method: 'GET', // 明确指定GET方法
              cache: 'no-store', // 不使用任何缓存
              headers: {
                  'Cache-Control': 'no-cache, no-store, must-revalidate',
                  'Pragma': 'no-cache',
                  'Expires': '0',
                  'X-Requested-With': 'XMLHttpRequest', // 添加AJAX标识
                  'X-Timestamp': timestamp // 添加时间戳头
              },
              credentials: 'same-origin' // 包含cookies
          });

          if (!response.ok) {
              try {
                  // 尝试解析错误响应为JSON
                  const errorText = await response.text();
                  let errorData;
                  try {
                      errorData = JSON.parse(errorText);
                  } catch (parseError) {
                      // 如果无法解析为JSON，则使用原始文本
                      console.error("无法解析错误响应为JSON:", parseError);
                      console.log("原始错误响应:", errorText);
                      errorData = { error: `预测请求失败: ${response.status} ${response.statusText}` };
                  }
                  throw new Error(errorData.error || `预测请求失败: ${response.status} ${response.statusText}`);
              } catch (e) {
                  throw new Error(`预测请求失败: ${e.message}`);
              }
          }

          // 先获取响应文本，然后尝试解析为JSON
          const responseText = await response.text();
          let data;
          try {
              data = JSON.parse(responseText);
          } catch (parseError) {
              console.error("无法解析响应为JSON:", parseError);
              console.log("原始响应:", responseText);
              throw new Error(`解析响应失败: ${parseError.message}`);
          }
          console.log("Raw API Response:", data);

          // 记录服务器时间和数据文件信息，用于调试
          console.log(`服务器时间: ${data.server_time || '未知'}`);
          console.log(`数据文件: ${data.data_file || '未知'}, 大小: ${data.data_file_size || '未知'} 字节, 修改时间: ${data.data_file_mtime || '未知'}`);
          console.log(`数据行数: ${data.data_rows || '未知'}, 数据哈希: ${data.data_hash || '未知'}`);
          console.log(`预测耗时: ${data.prediction_time || '未知'} 秒`);

          // 检查后端是否返回错误
          if (data.error) {
              throw new Error(data.error);
          }

          // 从 data.predictions 获取预测价格列表
          // 后端返回的 data.predictions 是一个数字列表，例如 [3500.0, 3510.0]
          // data.model_loaded 包含实际加载的模型名称
          // data.num_predictions 包含预测的数量

          // 确保 predictions 是一个数组
          const predictions = Array.isArray(data.predictions) ? data.predictions : [];
          const modelLoaded = data.model_loaded || '未知模型';

          console.log(`成功获取 ${modelLoaded} 模型的预测数据:`, predictions);

          // 记录预测统计信息
          if (data.prediction_stats) {
              console.log(`预测统计: 最小值=${data.prediction_stats.min}, 最大值=${data.prediction_stats.max}, 平均值=${data.prediction_stats.mean}`);
          }

          // 生成预测日期标签
          // 使用当前过滤的数据，而不是初始过滤的数据
          const currentFilteredData = filterDataByTimeRange(document.getElementById('timeRangeSelect').value);
          const lastHistoryDate = currentFilteredData.filteredLabels.length > 0 ?
                                new Date(currentFilteredData.filteredLabels[currentFilteredData.filteredLabels.length - 1]) :
                                new Date(); // 如果没有历史数据，则从今天开始

          console.log(`最后历史日期: ${lastHistoryDate.toISOString().split('T')[0]}`);

          const futureLabels = [];
          for (let i = 1; i <= predictions.length; i++) {
              const nextDate = new Date(lastHistoryDate);
              nextDate.setDate(lastHistoryDate.getDate() + i);
              futureLabels.push(nextDate.toISOString().split('T')[0]);
          }

          console.log(`生成的未来日期标签: ${futureLabels.join(', ')}`);

          return {
              prices: predictions, // 直接返回价格数组
              labels: futureLabels, // 添加预测日期标签
              model_loaded: modelLoaded,
              error: null,
              data_info: {
                  file: data.data_file,
                  rows: data.data_rows,
                  hash: data.data_hash,
                  timestamp: data.timestamp
              }
          };
      } catch (error) {
          console.error('获取预测数据时出错:', error);
          showPredictionError(error.message); // 显示具体的错误信息
          return {
              prices: [],
              model_loaded: '错误',
              error: error.message
          };
      } finally {
          isLoading = false;
          showLoadingState(false);
      }
  }

  // 显示/隐藏加载状态
  function showLoadingState(show) {
      if (show) {
          // 创建并显示加载指示器
          createLoadingIndicator();
          // console.log('显示加载指示器');
      } else {
          // 移除加载指示器
          removeLoadingIndicator();
          // console.log('移除加载指示器');
      }
  }

  // 创建加载指示器
  function createLoadingIndicator() {
      // 先移除可能存在的旧指示器
      removeLoadingIndicator();

      // 创建新的加载指示器
      const indicator = document.createElement('div');
      indicator.id = 'predictionLoadingIndicator';
      indicator.className = 'position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-white bg-opacity-75';
      indicator.style.zIndex = '1000';
      indicator.innerHTML = `
          <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">加载中...</span>
          </div>
          <span class="ms-2">正在使用模型预测...</span>
      `;

      // 添加到图表容器
      const chartContainer = document.querySelector('.chart-container');
      if (chartContainer) {
          chartContainer.style.position = 'relative';
          chartContainer.appendChild(indicator);
      }

      return indicator;
  }

  // 移除加载指示器
  function removeLoadingIndicator() {
      const indicator = document.getElementById('predictionLoadingIndicator');
      if (indicator && indicator.parentNode) {
          indicator.parentNode.removeChild(indicator);
          return true;
      }
      return false;
  }

  // 合并历史数据和预测数据
  const allLabels = [...labels, ...predictionLabels];

  // 注释掉移动平均线计算代码
  // const calculateMA = (prices, period) => {
  //     return prices.map((price, i) => {
  //         if (i < period - 1) return null;
  //         const slice = prices.slice(i - period + 1, i + 1);
  //         const sum = slice.reduce((a, b) => a + b, 0);
  //         return sum / period;
  //     });
  // };

  // // 计算MA5和MA20
  // const ma5Data = calculateMA(closingPrices, 5);
  // const ma20Data = calculateMA(closingPrices, 20);

  // 获取 canvas 元素
  const ctx = document.getElementById('closingPriceChart').getContext('2d');

  try {
      const hasAnnotationPlugin = Chart.registry.plugins.get('annotation') !== undefined;
      if (!hasAnnotationPlugin && window.ChartAnnotation) {
          Chart.register(window.ChartAnnotation);
      }

      const hasZoomPlugin = Chart.registry.plugins.get('zoom') !== undefined;
      if (!hasZoomPlugin && window.ChartZoom) {
          Chart.register(window.ChartZoom);
      }
  } catch (e) {
      console.error(e);
  }

  // 隐藏加载指示器，显示图表
  document.getElementById('chartLoadingIndicator').style.display = 'none';
  document.getElementById('closingPriceChart').style.display = 'block';

  // 页面加载时自动调用预测API
  async function loadInitialPrediction() {
      const initialModel = document.getElementById('modelSelect').value;
      const initialDays = 1; // 初始预测固定为1天 (明日)

      // 更新模型准确率显示
      updateModelDescription(initialModel);

      const predictionTitle = document.getElementById('prediction-title');
      if (predictionTitle) {
          predictionTitle.textContent = `预测收盘价 (明日)`;
      }
      document.getElementById('prediction-loading').style.display = 'block';
      document.getElementById('prediction-content').style.display = 'none';

      try {
          console.log(`开始初始预测，模型: ${initialModel}, 天数: ${initialDays}`);

          // 清除任何可能的缓存
          window.fetch = window.fetch.bind(window);

          const predictionResult = await fetchPrediction(initialModel, initialDays);

          if (predictionResult.error) {
              // fetchPrediction 内部已经调用了 showPredictionError
              console.error('初始预测API返回错误:', predictionResult.error);
              return; // 已经显示错误，直接返回
          }

          // 记录数据信息
          if (predictionResult.data_info) {
              console.log(`预测使用的数据文件: ${predictionResult.data_info.file}, 行数: ${predictionResult.data_info.rows}`);
          }

          const predictedPrices = predictionResult.prices;
          const futureLabels = predictionResult.labels || [];

          if (predictedPrices && predictedPrices.length > 0) {
              // 使用从fetchPrediction返回的预测日期标签
              closingPriceChart.data.labels = [...initialFilteredData.filteredLabels, ...futureLabels];
              closingPriceChart.data.datasets[0].data = [...initialFilteredData.filteredPrices, ...Array(futureLabels.length).fill(null)];
              closingPriceChart.data.datasets[1].data = [...Array(initialFilteredData.filteredLabels.length).fill(null), ...predictedPrices];
              closingPriceChart.update();

              const predictedPrice = predictedPrices[predictedPrices.length - 1];
              document.getElementById('prediction-loading').style.display = 'none';
              document.getElementById('prediction-content').style.display = 'block';
              const predictedPriceElement = document.getElementById('predicted-price');

              if (predictedPriceElement && typeof predictedPrice === 'number') {
                  predictedPriceElement.textContent = predictedPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                  predictedPriceElement.style.color = '#212529'; // 重置颜色
                  predictedPriceElement.style.fontSize = ''; // 重置字体大小

                  if (initialFilteredData.filteredPrices.length > 0) {
                      const currentPrice = initialFilteredData.filteredPrices[initialFilteredData.filteredPrices.length - 1];
                      const expectedChangePercent = ((predictedPrice - currentPrice) / currentPrice * 100);
                      const predictedChangeElement = document.getElementById('predicted-change');
                      if (predictedChangeElement) {
                          predictedChangeElement.className = 'text-muted'; // Default
                          let icon = '<i class="bi bi-dash"></i>';
                          let changeText = `0.00% (预期)`;
                          if (expectedChangePercent > 0) {
                              icon = '<i class="bi bi-arrow-up"></i>';
                              predictedChangeElement.className = 'text-success';
                              changeText = `+${expectedChangePercent.toFixed(2)}% (预期)`;
                          } else if (expectedChangePercent < 0) {
                              icon = '<i class="bi bi-arrow-down"></i>';
                              predictedChangeElement.className = 'text-danger';
                              changeText = `${expectedChangePercent.toFixed(2)}% (预期)`;
                          }
                          predictedChangeElement.innerHTML = `${icon} ${changeText}`;
                      }
                  }
              } else if (predictedPriceElement) {
                  showPredictionError('收到的预测价格无效。');
              }
               console.log(`模型 ${predictionResult.model_loaded} 预测了 ${predictedPrices.length} 天的价格。`);
          } else {
              showPredictionError('模型未返回有效的预测价格。');
          }
      } catch (error) {
          console.error('处理预测按钮点击时出错:', error);
          showPredictionError('预测处理失败: ' + error.message);
      } finally {
          isLoading = false;
          showLoadingState(false);
          const chartElement = document.getElementById('closingPriceChart');
          if (chartElement) {
              chartElement.style.display = 'block';
          }
          setTimeout(() => {
              if (closingPriceChart) {
                  closingPriceChart.update();
              }
          }, 100);
      }
      updateModelDescription(selectedModel);
  }

  // 调用初始预测加载函数
  loadInitialPrediction();

  // 初始化数据表格，确保显示正确的数据集总数
  if (chartData && chartData.labels && chartData.labels.length > 0) {
      console.log("初始化数据表格，数据集总数:", chartData.labels.length);

      // 延迟执行，确保DOM已经完全加载
      setTimeout(() => {
          // 调用更新表格函数
          updateDataTable(chartData);

          // 强制更新显示文本
          const countDisplay = document.getElementById('dataCountDisplay');
          if (countDisplay) {
              console.log("强制更新显示文本");
              countDisplay.textContent = `只显示前5条，共 ${chartData.labels.length} 条`;
          } else {
              console.warn("找不到#dataCountDisplay元素，无法强制更新显示文本");

              // 尝试查找所有可能的元素
              const allTextMuted = document.querySelectorAll('.text-muted');
              console.log("找到的.text-muted元素数量:", allTextMuted.length);

              if (allTextMuted.length > 0) {
                  // 遍历所有.text-muted元素，找到显示数据条数的那个
                  for (let i = 0; i < allTextMuted.length; i++) {
                      const text = allTextMuted[i].textContent;
                      if (text.includes('只显示前') || text.includes('条')) {
                          console.log("找到匹配的.text-muted元素:", text);
                          allTextMuted[i].textContent = `只显示前5条，共 ${chartData.labels.length} 条`;
                          break;
                      }
                  }
              }
          }
      }, 500);
  } else {
      console.warn("无法初始化数据表格，数据不完整");
  }

  // 根据时间范围过滤数据
  function filterDataByTimeRange(days) {
      /* console.log("开始过滤数据，当前完整数据集信息:", {
          "数据源": DATA_FILE_PATH || "未知",
          "日期数量": labels ? labels.length : 0,
          "日期范围": labels && labels.length > 0 ? labels[0] + " 至 " + labels[labels.length-1] : "无数据"
      }); */

      if (days === 'all' || !labels || labels.length === 0) {
          // console.log("显示全部数据，日期范围:", labels && labels.length > 0 ? labels[0] + " 至 " + labels[labels.length-1] : "无数据");
          return {
              filteredLabels: labels,
              filteredPrices: closingPrices,
              startIndex: 0
          };
      }

      // 将天数转换为整数
      const daysNum = parseInt(days);

      // 确保数据是按日期排序的（从早到晚）
      // 计算开始索引（确保不会小于0）
      const startIndex = Math.max(0, labels.length - daysNum);

      // 过滤数据
      let filteredLabels = labels.slice(startIndex);
      let filteredPrices = closingPrices.slice(startIndex);

      // 检查过滤后的数据是否按日期从早到晚排序
      if (filteredLabels.length > 1 && new Date(filteredLabels[0]) > new Date(filteredLabels[filteredLabels.length-1])) {
          // console.warn("过滤后的数据是倒序的，正在重新排序...");

          // 创建日期和价格的配对数组
          let pairs = filteredLabels.map((label, index) => {
              return {
                  date: label,
                  price: filteredPrices[index]
              };
          });

          // 按日期从早到晚排序
          pairs.sort((a, b) => new Date(a.date) - new Date(b.date));

          // 提取排序后的标签和价格
          filteredLabels = pairs.map(pair => pair.date);
          filteredPrices = pairs.map(pair => pair.price);

          // console.log("过滤数据重新排序后:", {
          //     "第一个日期": filteredLabels[0],
          //     "最后一个日期": filteredLabels[filteredLabels.length-1]
          // });
      }

      /* console.log(`显示最近 ${daysNum} 天数据，过滤后信息:`, {
          "过滤前日期数量": labels.length,
          "过滤后日期数量": filteredLabels.length,
          "过滤后日期范围": filteredLabels.length > 0 ? filteredLabels[0] + " 至 " + filteredLabels[filteredLabels.length-1] : "无数据",
          "过滤后前5个日期": filteredLabels.length > 0 ? filteredLabels.slice(0, Math.min(5, filteredLabels.length)).join(", ") : "无数据",
          "过滤后后5个日期": filteredLabels.length > 0 ? filteredLabels.slice(-Math.min(5, filteredLabels.length)).join(", ") : "无数据"
      }); */

      return {
          filteredLabels,
          filteredPrices,
          startIndex
      };
  }

  // 初始过滤数据（默认显示30天）
  const initialTimeRange = document.getElementById('timeRangeSelect').value;
  const initialFilteredData = filterDataByTimeRange(initialTimeRange);

  // 准备K线图数据
  const ohlcData = [];
  const volumeData = [];

  // 确保所有必要的数据都存在
  if (chartData && chartData.labels && chartData.closing_prices &&
      chartData.opening_prices && chartData.high_prices && chartData.low_prices &&
      chartData.volumes) {

      for (let i = 0; i < chartData.labels.length; i++) {
          // 创建K线数据
          ohlcData.push({
              x: chartData.labels[i],
              o: chartData.opening_prices[i],
              h: chartData.high_prices[i],
              l: chartData.low_prices[i],
              c: chartData.closing_prices[i]
          });

          // 创建成交量数据
          volumeData.push({
              x: chartData.labels[i],
              y: chartData.volumes[i],
              // 根据涨跌设置颜色
              color: i > 0 && chartData.closing_prices[i] >= chartData.closing_prices[i-1] ?
                     'rgba(75, 192, 192, 0.5)' : 'rgba(255, 99, 132, 0.5)'
          });
      }
  }

  // 创建图表
  const closingPriceChart = new Chart(ctx, {
      type: 'line',
      data: {
          labels: initialFilteredData.filteredLabels,
          datasets: [
              {
                  label: '历史收盘价',
                  data: initialFilteredData.filteredPrices,
                  borderColor: 'rgb(75, 192, 192)',
                  backgroundColor: 'rgba(75, 192, 192, 0.1)',
                  borderWidth: 2,
                  tension: 0.1,
                  fill: true
              },
              {
                  label: '预测价格',
                  data: [],
                  borderColor: 'rgb(255, 99, 132)',
                  backgroundColor: 'rgba(255, 99, 132, 0.1)',
                  borderWidth: 2,
                  borderDash: [5, 5],
                  tension: 0.1,
                  fill: true
              }
          ]
      },
      options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
              mode: 'index',
              intersect: false,
          },
          scales: {
              x: {
                  grid: {
                      display: false
                  }
              },
              y: {
                  beginAtZero: false,
                  grid: {
                      color: 'rgba(0, 0, 0, 0.05)'
                  }
              }
          },
          plugins: {
              legend: {
                  position: 'top',
              },
              tooltip: {
                  mode: 'index',
                  intersect: false
              },
              // 只有在插件可用时才启用注释功能
              ...(Chart.registry.plugins.get('annotation') !== undefined ? {
                  annotation: {
                      annotations: {
                          line1: {
                              type: 'line',
                              xMin: labels.length - 1,
                              xMax: labels.length - 1,
                              borderColor: 'rgb(169, 169, 169)',
                              borderWidth: 2,
                              borderDash: [6, 6],
                              label: {
                                  content: '预测开始',
                                  display: true,
                                  position: 'start'
                              }
                          }
                      }
                  }
              } : {}),

              // 只有在插件可用时才启用缩放功能
              ...(Chart.registry.plugins.get('zoom') !== undefined ? {
                  zoom: {
                      pan: {
                          enabled: true,
                          mode: 'x'
                      },
                      zoom: {
                          wheel: {
                              enabled: true,
                          },
                          pinch: {
                              enabled: true
                          },
                          mode: 'x',
                      }
                  }
              } : {})
          }
      }
  });

  // 创建成交量图表
  const volumeCtx = document.getElementById('volumeChart').getContext('2d');
  const volumeChart = new Chart(volumeCtx, {
      type: 'bar',
      data: {
          labels: initialFilteredData.filteredLabels,
          datasets: [{
              label: '成交量',
              data: chartData && chartData.volumes ?
                    chartData.volumes.slice(Math.max(0, chartData.volumes.length - initialFilteredData.filteredLabels.length)) :
                    [],
              backgroundColor: function(context) {
                  if (!chartData || !chartData.closing_prices) return 'rgba(75, 192, 192, 0.5)';

                  const index = context.dataIndex;
                  const dataLength = initialFilteredData.filteredLabels.length;
                  const dataStartIndex = Math.max(0, chartData.closing_prices.length - dataLength);

                  const actualIndex = dataStartIndex + index;
                  if (actualIndex <= 0 || actualIndex >= chartData.closing_prices.length) return 'rgba(75, 192, 192, 0.5)';

                  return chartData.closing_prices[actualIndex] >= chartData.closing_prices[actualIndex-1] ?
                         'rgba(75, 192, 192, 0.5)' : 'rgba(255, 99, 132, 0.5)';
              },
              borderColor: 'rgba(0, 0, 0, 0.1)',
              borderWidth: 1
          }]
      },
      options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
              legend: {
                  display: true,
                  position: 'top'
              },
              tooltip: {
                  mode: 'index',
                  intersect: false
              },
              title: {
                  display: true,
                  text: '成交量趋势'
              }
          },
          scales: {
              x: {
                  grid: {
                      display: true,
                      color: 'rgba(0, 0, 0, 0.05)'
                  }
              },
              y: {
                  beginAtZero: true,
                  grid: {
                      color: 'rgba(0, 0, 0, 0.05)'
                  },
                  ticks: {
                      callback: function(value) {
                          if (value >= 1000000) {
                              return (value / 1000000).toFixed(1) + 'M';
                          } else if (value >= 1000) {
                              return (value / 1000).toFixed(1) + 'K';
                          }
                          return value;
                      }
                  }
              }
          }
      }
  });

  // 更新数据表格
  function updateDataTable(data) {
      console.log("updateDataTable被调用，数据:", data);

      // 只有当有足够的数据时才更新表格
      if (!data || !data.labels) {
          console.warn("数据无效，无法更新表格");
          return;
      }

      if (data.labels.length < 1) {
          console.warn("数据集为空，无法更新表格");
          return;
      }

      const tableBody = document.querySelector('.table tbody');
      if (!tableBody) {
          console.warn("找不到表格tbody元素");
          return;
      }

      // 清空表格
      tableBody.innerHTML = '';

      // 获取最近的5条数据（或者所有数据，如果少于5条）
      const lastIndex = data.labels.length - 1;
      const startIndex = Math.max(0, lastIndex - 4);

      console.log("表格数据范围:", startIndex, "至", lastIndex, "，总条数:", data.labels.length);

      // 添加数据行
      for (let i = lastIndex; i >= startIndex; i--) {
          const row = document.createElement('tr');

          // 不再添加可点击的样式
          // 保留基本样式类
          row.classList.add('table-row-hover');

          // 计算涨跌幅
          const changePercent = i > 0
              ? ((data.closing_prices[i] - data.closing_prices[i-1]) / data.closing_prices[i-1] * 100).toFixed(1)
              : 0;

          const changeClass = changePercent > 0 ? 'text-success' : (changePercent < 0 ? 'text-danger' : '');
          const changeSign = changePercent > 0 ? '+' : '';

          // 设置行内容
          row.innerHTML = `
              <td>${data.labels[i]}</td>
              <td>${data.opening_prices && data.opening_prices[i] ? data.opening_prices[i].toLocaleString() : '-'}</td>
              <td>${data.high_prices && data.high_prices[i] ? data.high_prices[i].toLocaleString() : '-'}</td>
              <td>${data.low_prices && data.low_prices[i] ? data.low_prices[i].toLocaleString() : '-'}</td>
              <td>${data.closing_prices[i].toLocaleString()}</td>
              <td>${data.volumes && data.volumes[i] ? data.volumes[i].toLocaleString() : '-'}</td>
              <td class="${changeClass}">${changeSign}${changePercent}%</td>
          `;

          tableBody.appendChild(row);
      }

      // 更新显示的记录数
      const countDisplay = document.getElementById('dataCountDisplay');
      if (countDisplay) {
          // 显示"只显示前5条，共X条"格式
          const displayCount = lastIndex - startIndex + 1;
          const totalCount = data.labels.length;

          console.log("更新显示文本:", `只显示前${displayCount}条，共 ${totalCount} 条`);
          countDisplay.textContent = `只显示前${displayCount}条，共 ${totalCount} 条`;
      } else {
          console.warn("找不到#dataCountDisplay元素，尝试使用.text-muted选择器");

          // 尝试使用类选择器
          const textMutedElement = document.querySelector('.text-muted');
          if (textMutedElement) {
              const displayCount = lastIndex - startIndex + 1;
              const totalCount = data.labels.length;
              textMutedElement.textContent = `只显示前${displayCount}条，共 ${totalCount} 条`;
          } else {
              console.warn("找不到.text-muted元素，无法更新显示文本");
          }
      }

      // 为表格行添加点击事件处理程序
      addRowClickHandlers();
  }

  // 添加按钮事件监听器
  document.getElementById('zoomInBtn').addEventListener('click', function() {
      try {
          // 检查是否有缩放功能
          if (closingPriceChart.zoom && typeof closingPriceChart.zoom === 'function') {
              closingPriceChart.zoom(1.1);
              // 同步缩放成交量图表
              if (volumeChart.zoom && typeof volumeChart.zoom === 'function') {
                  volumeChart.zoom(1.1);
              }
          } else {
              // console.warn("图表没有 zoom 方法");
          }
      } catch (e) {
          // console.error("缩放操作失败:", e);
      }
  });

  document.getElementById('zoomOutBtn').addEventListener('click', function() {
      try {
          // 检查是否有缩放功能
          if (closingPriceChart.zoom && typeof closingPriceChart.zoom === 'function') {
              closingPriceChart.zoom(0.9);
              // 同步缩放成交量图表
              if (volumeChart.zoom && typeof volumeChart.zoom === 'function') {
                  volumeChart.zoom(0.9);
              }
          } else {
              // console.warn("图表没有 zoom 方法");
          }
      } catch (e) {
          // console.error("缩放操作失败:", e);
      }
  });

  document.getElementById('resetZoomBtn').addEventListener('click', function() {
      try {
          // 检查是否有重置缩放功能
          if (closingPriceChart.resetZoom && typeof closingPriceChart.resetZoom === 'function') {
              closingPriceChart.resetZoom();
              // 同步重置成交量图表
              if (volumeChart.resetZoom && typeof volumeChart.resetZoom === 'function') {
                  volumeChart.resetZoom();
              }
          } else {
              // console.warn("图表没有 resetZoom 方法");
              // 尝试通过重新加载页面来重置
              location.reload();
          }
      } catch (e) {
          // console.error("重置缩放操作失败:", e);
          // 如果重置失败，尝试重新加载页面
          location.reload();
      }
  });

  document.getElementById('applyFiltersBtn').addEventListener('click', async function() {
      const timeRange = document.getElementById('timeRangeSelect').value;
      const selectedModel = document.getElementById('modelSelect').value;
      const predictionDays = 1; // 固定预测1天

      currentModel = selectedModel;
      // 更新模型准确率显示
      updateModelDescription(selectedModel);

      const filteredData = filterDataByTimeRange(timeRange);

      closingPriceChart.data.labels = filteredData.filteredLabels;
      closingPriceChart.data.datasets[0].data = filteredData.filteredPrices;
      closingPriceChart.data.datasets[1].data = [];

      // 先更新图表，显示历史数据
      closingPriceChart.update();

      console.log(`应用过滤器: 时间范围=${timeRange}, 模型=${selectedModel}, 预测天数=${predictionDays}`);
      console.log(`过滤后的数据: 标签数=${filteredData.filteredLabels.length}, 价格数=${filteredData.filteredPrices.length}`);

      // 显示加载状态
      document.getElementById('prediction-loading').style.display = 'block';
      document.getElementById('prediction-content').style.display = 'none';

      // 调用后端API获取预测数据
      try {
          // 清除任何可能的缓存
          window.fetch = window.fetch.bind(window);

          const prediction = await fetchPrediction(selectedModel, predictionDays);

          // 记录数据信息
          if (prediction.data_info) {
              console.log(`预测使用的数据文件: ${prediction.data_info.file}, 行数: ${prediction.data_info.rows}`);
          }

          if (prediction.prices && prediction.prices.length > 0) {
              // 获取预测标签，如果没有则生成
              const predictionLabels = prediction.labels || [];

              // 更新图表数据，添加预测部分
              closingPriceChart.data.labels = [...filteredData.filteredLabels, ...predictionLabels];

              // 更新历史收盘价数据（在预测部分为null）
              closingPriceChart.data.datasets[0].data = [...filteredData.filteredPrices, ...Array(predictionLabels.length).fill(null)];

              // 更新预测价格数据（在历史部分为null）
              closingPriceChart.data.datasets[1].data = [...Array(filteredData.filteredLabels.length).fill(null), ...prediction.prices];

              // 更新图表
              closingPriceChart.update();

              // 更新预测价格卡片
              const predictedPrice = prediction.prices[prediction.prices.length - 1];

              // 隐藏加载状态，显示预测内容
              document.getElementById('prediction-loading').style.display = 'none';
              document.getElementById('prediction-content').style.display = 'block';

              // 预测天数固定为1天
              const predictionTitle = document.getElementById('prediction-title');
              if (predictionTitle) {
                  predictionTitle.textContent = '预测收盘价 (明日)';
              }

              // 更新预测价格
              const predictedPriceElement = document.getElementById('predicted-price');
              if (predictedPriceElement && predictedPrice) {
                  predictedPriceElement.textContent = predictedPrice.toLocaleString();

                  // 更新预期涨跌幅
                  if (filteredData.filteredPrices.length > 0) {
                      const currentPrice = filteredData.filteredPrices[filteredData.filteredPrices.length - 1];
                      const expectedChangePercent = ((predictedPrice - currentPrice) / currentPrice * 100).toFixed(2);
                      const predictedChangeElement = document.getElementById('predicted-change');

                      if (predictedChangeElement) {
                          if (expectedChangePercent > 0) {
                              predictedChangeElement.innerHTML = `<i class="bi bi-arrow-up"></i> +${expectedChangePercent}% (预期)`;
                              predictedChangeElement.className = 'text-success';
                          } else if (expectedChangePercent < 0) {
                              predictedChangeElement.innerHTML = `<i class="bi bi-arrow-down"></i> ${expectedChangePercent}% (预期)`;
                              predictedChangeElement.className = 'text-danger';
                          } else {
                              predictedChangeElement.innerHTML = `<i class="bi bi-dash"></i> 0.00% (预期)`;
                              predictedChangeElement.className = 'text-muted';
                          }
                      }
                  }
              }
          } else {
              // console.warn('预测API返回了空数据');
              showPredictionError('无法获取预测数据，请稍后再试。');
          }
      } catch (error) {
          // console.error('获取预测数据时出错:', error);
          showPredictionError('获取预测数据时出错: ' + error.message);
      } finally {
          // 移除加载指示器
          showLoadingState(false);

          // 确保图表可见
          const chartElement = document.getElementById('closingPriceChart');
          if (chartElement) {
              chartElement.style.display = 'block';
              // console.log('确保图表可见');
          }

          // 强制刷新图表区域
          setTimeout(() => {
              if (closingPriceChart) {
                  closingPriceChart.update();
                  // console.log('强制更新图表');
              }
          }, 100);
      }

      // console.log(`预测条件: 时间范围=${timeRange}天, 预测模型=${selectedModel}, 预测天数=${predictionDays}天`);

      // 更新模型说明
      updateModelDescription(selectedModel);
  });

  // 更新模型说明函数
  function updateModelDescription(model) {
      let description = '';
      let accuracy = '';

      // 获取模型描述
      switch(model) {
          case 'mlp':
              description = 'MLP (多层感知机) 模型是一种前馈神经网络，能够学习特征之间的非线性关系，适合处理多维特征数据。';
              break;
          case 'lstm':
              description = 'LSTM (长短期记忆网络) 模型擅长捕捉时间序列中的长期依赖关系，对价格趋势变化有较好的预测能力。';
              break;
          case 'cnn':
              description = 'CNN (卷积神经网络) 模型通过卷积层提取局部特征，能够识别时间序列中的模式和趋势，计算效率高。';
              break;
          default:
              description = '请选择预测模型';
      }

      // 从后端获取的模型指标中获取准确率
      // console.log(`获取 ${model} 模型的准确率:`, modelMetrics && modelMetrics[model] ? modelMetrics[model].accuracy : '未找到');

      if (modelMetrics && modelMetrics[model] && modelMetrics[model].accuracy !== undefined) {
          // 使用模型指标中的准确率
          accuracy = modelMetrics[model].accuracy.toFixed(2) + '%';
          // console.log(`使用模型指标中的准确率: ${accuracy}`);
      } else {
          // 如果没有获取到准确率，使用默认值
          switch(model) {
              case 'mlp': accuracy = '97.71%'; break;
              case 'lstm': accuracy = '97.34%'; break;
              case 'cnn': accuracy = '97.25%'; break;
              default: accuracy = 'N/A';
          }
          // console.log(`使用默认准确率: ${accuracy}`);
      }

      // 更新准确率显示
      const accuracyElement = document.querySelector('.progress-bar');
      if (accuracyElement) {
          // 提取准确率数值（去掉百分号）
          const accuracyValue = parseFloat(accuracy.replace('%', ''));
          // 设置进度条宽度（使用整数值）
          accuracyElement.style.width = `${Math.floor(accuracyValue)}%`;
          // 显示准确率（保留一位小数）
          accuracyElement.textContent = `${accuracyValue.toFixed(2)}%`;
          accuracyElement.setAttribute('aria-valuenow', accuracyValue);

          // 更新准确率说明文本
          const accuracyTextElement = document.querySelector('.card-title + .progress + .text-muted');
          if (accuracyTextElement) {
              accuracyTextElement.textContent = `基于${getModelFullName(model)}历史表现`;
          }
      }

      // 添加模型说明到页面
      const modelInfoElement = document.querySelector('.card-body .alert-info p');
      if (modelInfoElement) {
          modelInfoElement.innerHTML = `本系统使用<strong>${getModelFullName(model)}</strong>分析豆粕期货历史数据，预测未来价格走势。${description} 预测结果仅供参考，不构成投资建议。`;
      }
  }

  // 获取模型全名
  function getModelFullName(model) {
      switch(model) {
          case 'mlp':
              return '多层感知机 (MLP) ';
          case 'lstm':
              return '长短期记忆网络 (LSTM) ';
          case 'cnn':
              return '卷积神经网络 (CNN) ';
          default:
              return '深度学习模型';
      }
  }

  // 显示预测错误
  function showPredictionError(errorMessage) {
      // 隐藏加载状态，显示预测内容
      document.getElementById('prediction-loading').style.display = 'none';
      document.getElementById('prediction-content').style.display = 'block';

      // 更新预测价格为错误信息
      const predictedPriceElement = document.getElementById('predicted-price');
      if (predictedPriceElement) {
          predictedPriceElement.textContent = '预测失败';
          predictedPriceElement.style.fontSize = '1.5rem';
          predictedPriceElement.style.color = '#dc3545';
      }

      // 更新预期涨跌幅为错误信息
      const predictedChangeElement = document.getElementById('predicted-change');
      if (predictedChangeElement) {
          predictedChangeElement.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${errorMessage}`;
          predictedChangeElement.className = 'text-danger small';
      }

      // 显示错误提示
      // console.error('预测失败:', errorMessage);
  }

  // 更新模型描述和准确率
  function updateModelDescription(modelType) {
      console.log("更新模型描述，当前模型:", modelType, "模型指标:", modelMetrics);

      // 获取DOM元素
      const accuracyBar = document.getElementById('model-accuracy-bar');
      const modelDescription = document.getElementById('model-description');

      // 检查模型指标是否存在
      if (!modelMetrics || !modelMetrics[modelType]) {
          console.warn("模型指标数据不存在:", modelType);
          if (accuracyBar) {
              accuracyBar.style.width = "0%";
              accuracyBar.textContent = "0%";
              accuracyBar.setAttribute('aria-valuenow', 0);
          }
          if (modelDescription) {
              modelDescription.textContent = "模型数据不可用";
          }
          return;
      }

      // 获取当前模型的准确率
      const accuracy = modelMetrics[modelType].accuracy || 0;
      const rmse = modelMetrics[modelType].rmse || 0;
      const mae = modelMetrics[modelType].mae || 0;
      const r2 = modelMetrics[modelType].r2 || 0;

      // 更新准确率进度条
      if (accuracyBar) {
          accuracyBar.style.width = `${accuracy}%`;
          accuracyBar.textContent = `${accuracy.toFixed(2)}%`;
          accuracyBar.setAttribute('aria-valuenow', accuracy);

          // 根据准确率设置颜色
          if (accuracy >= 95) {
              accuracyBar.className = 'progress-bar bg-success';
          } else if (accuracy >= 90) {
              accuracyBar.className = 'progress-bar bg-info';
          } else if (accuracy >= 80) {
              accuracyBar.className = 'progress-bar bg-warning';
          } else {
              accuracyBar.className = 'progress-bar bg-danger';
          }
      }

      // 更新模型描述
      if (modelDescription) {
          let modelName = '';
          switch (modelType) {
              case 'mlp':
                  modelName = 'MLP';
                  break;
              case 'lstm':
                  modelName = 'LSTM';
                  break;
              case 'cnn':
                  modelName = 'CNN';
                  break;
              default:
                  modelName = modelType.toUpperCase();
          }

          modelDescription.textContent = `基于${modelName}模型 (RMSE: ${rmse.toFixed(2)}, MAE: ${mae.toFixed(2)})`;
      }

      console.log(`已更新模型描述: ${modelType}, 准确率: ${accuracy}%`);
  }

  // 初始化时更新模型说明
  updateModelDescription('mlp');

  // 添加模型选择的事件监听器
  document.getElementById('modelSelect').addEventListener('change', function() {
      const selectedModel = this.value;
      updateModelDescription(selectedModel);
  });

  // 添加时间范围选择的事件监听器（保留但不再需要用户交互）
  const timeRangeSelect = document.getElementById('timeRangeSelect');
  if (timeRangeSelect) {
      timeRangeSelect.addEventListener('change', function() {
          // 获取选择的时间范围
          const timeRange = this.value;

          // 根据选择的时间范围过滤数据
          const filteredData = filterDataByTimeRange(timeRange);

          // 更新所有图表的数据
          updateAllCharts(filteredData);

          // 自动点击预测按钮
          document.getElementById('applyFiltersBtn').click();
      });
  }

  // 更新所有图表的函数
  function updateAllCharts(filteredData) {
      // 更新主价格图表
      if (closingPriceChart) {
          closingPriceChart.data.labels = filteredData.filteredLabels;
          closingPriceChart.data.datasets[0].data = filteredData.filteredPrices;
          closingPriceChart.update();
      }

      // 更新成交量图表
      if (volumeChart && chartData && chartData.volumes) {
          volumeChart.data.labels = filteredData.filteredLabels;
          volumeChart.data.datasets[0].data = chartData.volumes.slice(
              Math.max(0, chartData.volumes.length - filteredData.filteredLabels.length)
          );
          volumeChart.update();
      }

      // 更新RSI_14图表
      const rsiChart = Chart.getChart(document.getElementById('rsiChart'));
      if (rsiChart && chartData && chartData.rsi) {
          rsiChart.data.labels = filteredData.filteredLabels;
          rsiChart.data.datasets[0].data = chartData.rsi.slice(
              Math.max(0, chartData.rsi.length - filteredData.filteredLabels.length)
          );
          // 更新超买超卖线
          rsiChart.data.datasets[1].data = Array(filteredData.filteredLabels.length).fill(70);
          rsiChart.data.datasets[2].data = Array(filteredData.filteredLabels.length).fill(30);
          rsiChart.update();
      }

      // 更新HV_20与ATR_14图表
      const volatilityChart = Chart.getChart(document.getElementById('volatilityChart'));
      if (volatilityChart && chartData) {
          volatilityChart.data.labels = filteredData.filteredLabels;

          // 更新HV_20数据
          if (chartData.hv20 && volatilityChart.data.datasets[0]) {
              volatilityChart.data.datasets[0].data = chartData.hv20.slice(
                  Math.max(0, chartData.hv20.length - filteredData.filteredLabels.length)
              );
          }

          // 更新ATR_14数据
          if (chartData.atr14 && volatilityChart.data.datasets[1]) {
              volatilityChart.data.datasets[1].data = chartData.atr14.slice(
                  Math.max(0, chartData.atr14.length - filteredData.filteredLabels.length)
              );
          }

          volatilityChart.update();
      }

      // 更新MACD图表
      const macdChart = Chart.getChart(document.getElementById('macdChart'));
      if (macdChart && chartData && chartData.MACD) {
          macdChart.data.labels = filteredData.filteredLabels;

          // 更新MACD数据
          macdChart.data.datasets[0].data = chartData.MACD.slice(
              Math.max(0, chartData.MACD.length - filteredData.filteredLabels.length)
          );

          macdChart.update();
      }

      // 更新OBV图表
      const obvChart = Chart.getChart(document.getElementById('obvChart'));
      if (obvChart && chartData && chartData.obv) {
          obvChart.data.labels = filteredData.filteredLabels;
          obvChart.data.datasets[0].data = chartData.obv.slice(
              Math.max(0, chartData.obv.length - filteredData.filteredLabels.length)
          );
          obvChart.update();
      }

      // 更新最高价和最低价图表
      const highLowChart = Chart.getChart(document.getElementById('highLowChart'));
      if (highLowChart && chartData && chartData.high_prices && chartData.low_prices) {
          highLowChart.data.labels = filteredData.filteredLabels;

          // 更新最高价数据
          highLowChart.data.datasets[0].data = chartData.high_prices.slice(
              Math.max(0, chartData.high_prices.length - filteredData.filteredLabels.length)
          );

          // 更新最低价数据
          highLowChart.data.datasets[1].data = chartData.low_prices.slice(
              Math.max(0, chartData.low_prices.length - filteredData.filteredLabels.length)
          );

          highLowChart.update();
      }

      // 更新大豆价格和玉米价格图表
      const acCloseChart = Chart.getChart(document.getElementById('acCloseChart'));
      if (acCloseChart && chartData && chartData.a_close && chartData.c_close) {
          acCloseChart.data.labels = filteredData.filteredLabels;

          // 更新大豆价格数据
          acCloseChart.data.datasets[0].data = chartData.a_close.slice(
              Math.max(0, chartData.a_close.length - filteredData.filteredLabels.length)
          );

          // 更新玉米价格数据
          acCloseChart.data.datasets[1].data = chartData.c_close.slice(
              Math.max(0, chartData.c_close.length - filteredData.filteredLabels.length)
          );

          acCloseChart.update();
      }
  }

  // 预测天数固定为1天
  document.getElementById('predictionRange').value = '1';
  const predictionTitle = document.getElementById('prediction-title');
  if (predictionTitle) {
      predictionTitle.textContent = '预测收盘价 (明日)';
  }

  // 创建RSI_14指标图表
  if (chartData && chartData.rsi) {
      const rsiCtx = document.getElementById('rsiChart').getContext('2d');
      const rsiChart = new Chart(rsiCtx, {
          type: 'line',
          data: {
              labels: initialFilteredData.filteredLabels,
              datasets: [
                  {
                      label: 'RSI_14',
                      data: chartData.rsi.slice(Math.max(0, chartData.rsi.length - initialFilteredData.filteredLabels.length)),
                      borderColor: 'rgb(255, 159, 64)',
                      backgroundColor: 'rgba(255, 159, 64, 0.1)',
                      borderWidth: 2,
                      tension: 0.1,
                      fill: true
                  },
                  {
                      label: '超买线 (70)',
                      data: Array(initialFilteredData.filteredLabels.length).fill(70),
                      borderColor: 'rgba(255, 99, 132, 0.7)',
                      borderWidth: 1,
                      borderDash: [5, 5],
                      pointRadius: 0,
                      fill: false
                  },
                  {
                      label: '超卖线 (30)',
                      data: Array(initialFilteredData.filteredLabels.length).fill(30),
                      borderColor: 'rgba(75, 192, 192, 0.7)',
                      borderWidth: 1,
                      borderDash: [5, 5],
                      pointRadius: 0,
                      fill: false
                  }
              ]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  tooltip: {
                      mode: 'index',
                      intersect: false
                  },
                  title: {
                      display: true,
                      text: 'RSI_14指标'
                  }
              },
              scales: {
                  x: {
                      display: false
                  },
                  y: {
                      min: 0,
                      max: 100,
                      grid: {
                          color: 'rgba(0, 0, 0, 0.05)'
                      }
                  }
              }
          }
      });
  }

  // 创建MACD指标图表
  if (chartData && chartData.MACD) {
      const macdCtx = document.getElementById('macdChart').getContext('2d');
      const macdChart = new Chart(macdCtx, {
          type: 'line',
          data: {
              labels: initialFilteredData.filteredLabels,
              datasets: [
                  {
                      label: 'MACD',
                      data: chartData.MACD.slice(Math.max(0, chartData.MACD.length - initialFilteredData.filteredLabels.length)),
                      borderColor: 'rgb(255, 99, 132)',
                      backgroundColor: 'rgba(255, 99, 132, 0.1)',
                      borderWidth: 2,
                      tension: 0.1,
                      fill: true
                  }
              ]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  tooltip: {
                      mode: 'index',
                      intersect: false
                  },
                  title: {
                      display: true,
                      text: 'MACD指标'
                  }
              },
              scales: {
                  x: {
                      display: false
                  },
                  y: {
                      grid: {
                          color: 'rgba(0, 0, 0, 0.05)'
                      }
                  }
              }
          }
      });
  }

  // 创建HV_20与ATR_14指标图表
  if (chartData) {
      const volatilityCtx = document.getElementById('volatilityChart').getContext('2d');

      // 准备数据
      const datasets = [];

      // 添加历史波动率数据
      if (chartData.hv20) {
          datasets.push({
              label: 'HV_20',
              data: chartData.hv20.slice(Math.max(0, chartData.hv20.length - initialFilteredData.filteredLabels.length)),
              borderColor: 'rgb(255, 99, 132)',
              backgroundColor: 'rgba(255, 99, 132, 0.1)',
              borderWidth: 2,
              tension: 0.1,
              fill: false,
              yAxisID: 'y'
          });
      }

      // 添加ATR数据
      if (chartData.atr14) {
          datasets.push({
              label: 'ATR_14',
              data: chartData.atr14.slice(Math.max(0, chartData.atr14.length - initialFilteredData.filteredLabels.length)),
              borderColor: 'rgb(54, 162, 235)',
              backgroundColor: 'rgba(54, 162, 235, 0.1)',
              borderWidth: 2,
              tension: 0.1,
              fill: false,
              yAxisID: 'y1'
          });
      }

      // 创建图表
      const volatilityChart = new Chart(volatilityCtx, {
          type: 'line',
          data: {
              labels: initialFilteredData.filteredLabels,
              datasets: datasets
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  tooltip: {
                      mode: 'index',
                      intersect: false
                  },
                  title: {
                      display: true,
                      text: 'HV_20与ATR_14指标'
                  }
              },
              scales: {
                  x: {
                      display: false
                  },
                  y: {
                      type: 'linear',
                      display: true,
                      position: 'left',
                      title: {
                          display: true,
                          text: 'HV_20'
                      },
                      grid: {
                          color: 'rgba(0, 0, 0, 0.05)'
                      }
                  },
                  y1: {
                      type: 'linear',
                      display: true,
                      position: 'right',
                      title: {
                          display: true,
                          text: 'ATR_14'
                      },
                      grid: {
                          drawOnChartArea: false
                      }
                  }
              }
          }
      });
  }

  // 创建OBV指标图表
  if (chartData && chartData.obv) {
      const obvCtx = document.getElementById('obvChart').getContext('2d');
      const obvChart = new Chart(obvCtx, {
          type: 'line',
          data: {
              labels: initialFilteredData.filteredLabels,
              datasets: [
                  {
                      label: 'OBV',
                      data: chartData.obv.slice(Math.max(0, chartData.obv.length - initialFilteredData.filteredLabels.length)),
                      borderColor: 'rgb(153, 102, 255)',
                      backgroundColor: 'rgba(153, 102, 255, 0.1)',
                      borderWidth: 2,
                      tension: 0.1,
                      fill: true
                  }
              ]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  tooltip: {
                      mode: 'index',
                      intersect: false
                  },
                  title: {
                      display: true,
                      text: 'OBV指标'
                  }
              },
              scales: {
                  x: {
                      display: false
                  },
                  y: {
                      grid: {
                          color: 'rgba(0, 0, 0, 0.05)'
                      },
                      ticks: {
                          callback: function(value) {
                              if (Math.abs(value) >= 1000000) {
                                  return (value / 1000000).toFixed(1) + 'M';
                              } else if (Math.abs(value) >= 1000) {
                                  return (value / 1000).toFixed(1) + 'K';
                              }
                              return value;
                          }
                      }
                  }
              }
          }
      });
  }

  // 创建最高价和最低价图表
  if (chartData && chartData.high_prices && chartData.low_prices) {
      const highLowCtx = document.getElementById('highLowChart').getContext('2d');
      const highLowChart = new Chart(highLowCtx, {
          type: 'line',
          data: {
              labels: initialFilteredData.filteredLabels,
              datasets: [
                  {
                      label: '最高价',
                      data: chartData.high_prices.slice(Math.max(0, chartData.high_prices.length - initialFilteredData.filteredLabels.length)),
                      borderColor: 'rgb(255, 99, 132)',
                      backgroundColor: 'rgba(255, 99, 132, 0.1)',
                      borderWidth: 2,
                      tension: 0.1,
                      fill: false
                  },
                  {
                      label: '最低价',
                      data: chartData.low_prices.slice(Math.max(0, chartData.low_prices.length - initialFilteredData.filteredLabels.length)),
                      borderColor: 'rgb(75, 192, 192)',
                      backgroundColor: 'rgba(75, 192, 192, 0.1)',
                      borderWidth: 2,
                      tension: 0.1,
                      fill: false
                  }
              ]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  tooltip: {
                      mode: 'index',
                      intersect: false
                  },
                  title: {
                      display: true,
                      text: '最高价和最低价'
                  }
              },
              scales: {
                  x: {
                      display: true,
                      grid: {
                          display: false
                      }
                  },
                  y: {
                      grid: {
                          color: 'rgba(0, 0, 0, 0.05)'
                      }
                  }
              }
          }
      });
  }

  // 创建大豆价格和玉米价格图表
  if (chartData && chartData.a_close && chartData.c_close) {
      const acCloseCtx = document.getElementById('acCloseChart').getContext('2d');
      const acCloseChart = new Chart(acCloseCtx, {
          type: 'line',
          data: {
              labels: initialFilteredData.filteredLabels,
              datasets: [
                  {
                      label: '大豆价格',
                      data: chartData.a_close.slice(Math.max(0, chartData.a_close.length - initialFilteredData.filteredLabels.length)),
                      borderColor: 'rgb(255, 159, 64)',
                      backgroundColor: 'rgba(255, 159, 64, 0.1)',
                      borderWidth: 2,
                      tension: 0.1,
                      fill: false,
                      yAxisID: 'y'
                  },
                  {
                      label: '玉米价格',
                      data: chartData.c_close.slice(Math.max(0, chartData.c_close.length - initialFilteredData.filteredLabels.length)),
                      borderColor: 'rgb(54, 162, 235)',
                      backgroundColor: 'rgba(54, 162, 235, 0.1)',
                      borderWidth: 2,
                      tension: 0.1,
                      fill: false,
                      yAxisID: 'y1'
                  }
              ]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  tooltip: {
                      mode: 'index',
                      intersect: false
                  },
                  title: {
                      display: true,
                      text: '大豆价格和玉米价格'
                  }
              },
              scales: {
                  x: {
                      display: true,
                      grid: {
                          display: false
                      }
                  },
                  y: {
                      type: 'linear',
                      display: true,
                      position: 'left',
                      title: {
                          display: true,
                          text: '大豆价格'
                      },
                      grid: {
                          color: 'rgba(0, 0, 0, 0.05)'
                      }
                  },
                  y1: {
                      type: 'linear',
                      display: true,
                      position: 'right',
                      title: {
                          display: true,
                          text: '玉米价格'
                      },
                      grid: {
                          drawOnChartArea: false
                      }
                  }
              }
          }
      });
  }


  // 文件上传功能
  document.getElementById('uploadDataBtn').addEventListener('click', function() {
      // 获取表单和文件
      const form = document.getElementById('uploadDataForm');
      const fileInput = document.getElementById('dataFile');

      // 检查是否选择了文件
      if (!fileInput.files || fileInput.files.length === 0) {
          alert('请选择要上传的CSV文件');
          return;
      }

      // 检查文件类型
      const file = fileInput.files[0];
      if (!file.name.toLowerCase().endsWith('.csv')) {
          alert('请选择CSV格式的文件');
          return;
      }

      // 创建FormData对象
      const formData = new FormData();
      formData.append('file', file);

      // 显示上传状态
      const uploadStatus = document.getElementById('uploadStatus');
      const uploadProgressBar = document.getElementById('uploadProgressBar');
      const uploadStatusText = document.getElementById('uploadStatusText');

      uploadStatus.classList.remove('d-none');
      uploadProgressBar.style.width = '0%';
      uploadStatusText.textContent = '准备上传...';

      // 禁用上传按钮
      const uploadBtn = document.getElementById('uploadDataBtn');
      uploadBtn.disabled = true;

      // 发送请求
      fetch('/viz/api/upload', {
          method: 'POST',
          body: formData
      })
      .then(response => {
          uploadProgressBar.style.width = '100%';

          if (!response.ok) {
              if (response.status === 500) {
                  // 尝试解析错误消息
                  return response.json().then(data => {
                      throw new Error(data.error || `上传失败: ${response.status} ${response.statusText}`);
                  }).catch(err => {
                      // 如果JSON解析失败，使用原始错误
                      throw new Error(`上传失败: ${response.status} ${response.statusText}`);
                  });
              } else {
                  throw new Error(`上传失败: ${response.status} ${response.statusText}`);
              }
          }

          uploadStatusText.textContent = '上传成功，正在处理数据...';

          // 安全地解析JSON
          return response.text().then(text => {
              try {
                  // 尝试解析JSON
                  return JSON.parse(text);
              } catch (e) {
                  // console.error('JSON解析错误:', e);
                  // console.log('原始响应:', text);
                  throw new Error('服务器返回的数据格式无效');
              }
          });
      })
      .then(data => {
          if (data.success) {
              // 上传成功
              const fileName = document.getElementById('dataFile').files[0].name;
              let statusMessage = `文件 ${fileName} 上传成功`;

              // 添加记录数信息（如果可用）
              if (data.rows !== undefined) {
                  statusMessage += `，共 ${data.rows} 条记录`;
              }

              uploadStatusText.textContent = statusMessage;

              // 更新图表数据
              if (data.chart_data) {
                  // 更新全局数据
                  chartData = data.chart_data;
                  labels = data.chart_data.labels;
                  closingPrices = data.chart_data.closing_prices;

                  // 更新显示的总数据条数
                  const countDisplay = document.getElementById('dataCountDisplay');
                  if (countDisplay) {
                      // 计算实际的记录数
                      const totalRecords = chartData.labels ? chartData.labels.length : 0;
                      countDisplay.textContent = `只显示前5条，共 ${totalRecords} 条`;
                  }

                  // 根据时间范围过滤数据
                  const timeRange = document.getElementById('timeRangeSelect').value;
                  const filteredData = filterDataByTimeRange(timeRange);

                  // 更新所有图表
                  updateAllCharts(filteredData);

                  // 清除预测数据
                  closingPriceChart.data.datasets[1].data = [];
                  closingPriceChart.update();

                  // 更新数据表格
                  updateDataTable(chartData);

                  // 更新价格预测卡片
                  updatePricePredictionCards();

                  // 自动触发预测
                  console.log("上传新文件后自动触发预测");
                  // 确保使用最新数据进行预测
                  setTimeout(() => {
                      document.getElementById('applyFiltersBtn').click();
                  }, 500); // 添加短暂延迟，确保数据已更新

                  // 显示成功消息
                  const fileName = document.getElementById('dataFile').files[0].name;
                  let notificationMessage = `文件 ${fileName} 上传成功，图表和预测已使用新数据更新`;

                  // 添加记录数信息（如果可用）
                  if (data.rows !== undefined) {
                      notificationMessage += `，共 ${data.rows} 条记录`;
                  }

                  showNotification(notificationMessage, 'success');

                  // 关闭模态框
                  setTimeout(() => {
                      const modal = bootstrap.Modal.getInstance(document.getElementById('uploadDataModal'));
                      if (modal) {
                          modal.hide();
                      }
                  }, 1500);
              }
          } else {
              // 上传失败
              uploadStatusText.textContent = data.error || '上传失败';
              uploadProgressBar.classList.remove('bg-primary');
              uploadProgressBar.classList.add('bg-danger');

              // 特殊处理"数据重复"的错误消息
              if (data.error && data.error.includes('数据重复')) {
                  showNotification(data.error, 'warning');
              } else {
                  showNotification('上传失败: ' + (data.error || '未知错误'), 'danger');
              }
          }
      })
      .catch(error => {
          // console.error('上传文件时出错:', error);
          uploadStatusText.textContent = `上传失败: ${error.message}`;
          uploadProgressBar.classList.remove('bg-primary');
          uploadProgressBar.classList.add('bg-danger');
          showNotification('上传失败: ' + error.message, 'danger');
      })
      .finally(() => {
          // 启用上传按钮
          uploadBtn.disabled = false;
      });
  });

  // 显示通知消息
  function showNotification(message, type = 'success', autoHideDelay = 5000) {
      // 创建通知元素
      const notification = document.createElement('div');
      notification.className = `toast align-items-center text-white bg-${type} border-0`;
      notification.setAttribute('role', 'alert');
      notification.setAttribute('aria-live', 'assertive');
      notification.setAttribute('aria-atomic', 'true');

      notification.innerHTML = `
          <div class="d-flex">
              <div class="toast-body">
                  ${message}
              </div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
      `;

      // 创建或获取通知容器
      let container = document.querySelector('.toast-container');
      if (!container) {
          container = document.createElement('div');
          container.className = 'toast-container position-fixed top-0 end-0 p-3';
          document.body.appendChild(container);
      }

      // 添加通知到容器
      container.appendChild(notification);

      // 显示通知，如果autoHideDelay为0则不自动关闭
      const toastOptions = autoHideDelay > 0 ? { delay: autoHideDelay } : { autohide: false };
      const toast = new bootstrap.Toast(notification, toastOptions);
      toast.show();

      // 通知关闭后移除元素
      notification.addEventListener('hidden.bs.toast', function() {
          notification.remove();
      });

      // 返回toast实例，以便外部可以控制关闭
      return toast;
  }

  // 更新价格预测卡片
  function updatePricePredictionCards() {
      if (closingPrices && closingPrices.length > 0) {
          // 当前价格
          const currentPrice = closingPrices[closingPrices.length - 1];
          const currentPriceElement = document.querySelector('.data-card:nth-child(1) .display-5');
          if (currentPriceElement) {
              currentPriceElement.textContent = currentPrice.toLocaleString();
          }

          // 计算今日涨跌幅
          if (closingPrices.length > 1) {
              const yesterdayPrice = closingPrices[closingPrices.length - 2];
              const changePercent = ((currentPrice - yesterdayPrice) / yesterdayPrice * 100).toFixed(1);
              const changeElement = document.querySelector('.data-card:nth-child(1) .text-success');

              if (changeElement) {
                  if (changePercent > 0) {
                      changeElement.innerHTML = `<i class="bi bi-arrow-up"></i> +${changePercent}% (今日)`;
                      changeElement.className = 'text-success';
                  } else if (changePercent < 0) {
                      changeElement.innerHTML = `<i class="bi bi-arrow-down"></i> ${changePercent}% (今日)`;
                      changeElement.className = 'text-danger';
                  } else {
                      changeElement.innerHTML = `<i class="bi bi-dash"></i> 0.0% (今日)`;
                      changeElement.className = 'text-muted';
                  }
              }
          }

          // 预测价格
          if (predictionPrices && predictionPrices.length > 0) {
              const predictedPrice = predictionPrices[predictionPrices.length - 1];
              const predictedPriceElement = document.querySelector('.data-card:nth-child(2) .display-5');

              if (predictedPriceElement) {
                  predictedPriceElement.textContent = predictedPrice.toLocaleString();
              }

              // 计算预期涨跌幅
              const expectedChangePercent = ((predictedPrice - currentPrice) / currentPrice * 100).toFixed(2);
              const expectedChangeElement = document.querySelector('.data-card:nth-child(2) .text-success');

              if (expectedChangeElement) {
                  if (expectedChangePercent > 0) {
                      expectedChangeElement.innerHTML = `<i class="bi bi-arrow-up"></i> +${expectedChangePercent}% (预期)`;
                      expectedChangeElement.className = 'text-success';
                  } else if (expectedChangePercent < 0) {
                      expectedChangeElement.innerHTML = `<i class="bi bi-arrow-down"></i> ${expectedChangePercent}% (预期)`;
                      expectedChangeElement.className = 'text-danger';
                  } else {
                      expectedChangeElement.innerHTML = `<i class="bi bi-dash"></i> 0.00% (预期)`;
                      expectedChangeElement.className = 'text-muted';
                  }
              }
          }
      }
  }

  // 调用函数更新价格预测卡片
  updatePricePredictionCards();

  // 编辑数据功能
  let currentEditDate = null;

  // 为表格中的行添加点击事件（已禁用）
  function addRowClickHandlers() {
      // 空函数，不再为表格行添加点击事件
      // 根据需求，历史数据中点击不再有操作
  }

  // 保存编辑按钮点击事件
  document.getElementById('saveEditBtn').addEventListener('click', async function() {
      // 获取编辑表单中的数据
      const date = currentEditDate;
      const open = document.getElementById('editOpen').value;
      const high = document.getElementById('editHigh').value;
      const low = document.getElementById('editLow').value;
      const close = document.getElementById('editClose').value;
      const volume = document.getElementById('editVolume').value;

      // 验证数据
      if (!date || !close) {
          showNotification('日期和收盘价是必填字段', 'danger');
          return;
      }

      try {
          // 显示加载状态
          showNotification('正在保存数据...', 'info');

          // 发送编辑请求
          const response = await fetch('/viz/api/edit', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                  date,
                  open: open ? parseFloat(open) : null,
                  high: high ? parseFloat(high) : null,
                  low: low ? parseFloat(low) : null,
                  close: parseFloat(close),
                  volume: volume ? parseInt(volume) : null
              })
          });

          // 解析响应
          const data = await response.json();

          if (data.success) {
              // 关闭模态框
              const modal = bootstrap.Modal.getInstance(document.getElementById('editDataModal'));
              if (modal) {
                  modal.hide();
              }

              // 更新图表数据
              if (data.chart_data) {
                  // 保存编辑前的数据信息，用于比较
                  const oldLabelsFirst = labels && labels.length > 0 ? labels[0] : "无数据";
                  const oldLabelsLast = labels && labels.length > 0 ? labels[labels.length-1] : "无数据";
                  const oldLabelsLength = labels ? labels.length : 0;

                  // 更新全局数据，但保持使用相同的数据源
                  chartData = data.chart_data;
                  labels = data.chart_data.labels;
                  closingPrices = data.chart_data.closing_prices;

                  // 更新显示的总数据条数
                  const countDisplay = document.getElementById('dataCountDisplay');
                  if (countDisplay) {
                      // 计算实际的记录数
                      const totalRecords = chartData.labels ? chartData.labels.length : 0;
                      countDisplay.textContent = `只显示前5条，共 ${totalRecords} 条`;
                  }

                  // 详细记录数据变化，检查是否更换了数据集
                  // console.log("编辑前数据信息:", {
                  //     "日期数量": oldLabelsLength,
                  //     "日期范围": oldLabelsFirst + " 至 " + oldLabelsLast,
                  //     "前5个日期": labels && labels.length >= 5 ? labels.slice(0, 5).join(", ") : "无足够数据",
                  //     "后5个日期": labels && labels.length >= 5 ? labels.slice(-5).join(", ") : "无足够数据"
                  // });

                  // console.log("编辑后数据信息:", {
                  //     "日期数量": labels.length,
                  //     "日期范围": labels[0] + " 至 " + labels[labels.length-1],
                  //     "前5个日期": labels.slice(0, 5).join(", "),
                  //     "后5个日期": labels.slice(-5).join(", ")
                  // });

                  // 检查数据集是否被更换（通过比较日期范围的起始日期）
                  if (oldLabelsFirst !== labels[0]) {
                      // console.warn("警告：数据集的起始日期发生了变化，可能更换了数据源！");
                      // console.warn("原始起始日期: " + oldLabelsFirst + ", 新起始日期: " + labels[0]);
                  } else {
                      // console.log("数据集的起始日期未变化，仍然使用相同的数据源");
                  }

                  // 根据时间范围过滤数据
                  const timeRange = document.getElementById('timeRangeSelect').value;
                  const filteredData = filterDataByTimeRange(timeRange);

                  // 检查数据是否按日期从早到晚排序
                  // console.log("更新图表前检查数据排序:", {
                  //     "第一个日期": filteredData.filteredLabels[0],
                  //     "最后一个日期": filteredData.filteredLabels[filteredData.filteredLabels.length-1]
                  // });

                  // 确保数据是按日期从早到晚排序的
                  let sortedLabels = [...filteredData.filteredLabels];
                  let sortedPrices = [...filteredData.filteredPrices];

                  // 如果发现数据是倒序的（最后一个日期早于第一个日期），则进行排序
                  if (new Date(sortedLabels[0]) > new Date(sortedLabels[sortedLabels.length-1])) {
                      // console.warn("检测到数据倒序，正在重新排序...");

                      // 创建日期和价格的配对数组
                      let pairs = sortedLabels.map((label, index) => {
                          return {
                              date: label,
                              price: sortedPrices[index]
                          };
                      });

                      // 按日期从早到晚排序
                      pairs.sort((a, b) => new Date(a.date) - new Date(b.date));

                      // 提取排序后的标签和价格
                      sortedLabels = pairs.map(pair => pair.date);
                      sortedPrices = pairs.map(pair => pair.price);

                      // console.log("重新排序后:", {
                      //     "第一个日期": sortedLabels[0],
                      //     "最后一个日期": sortedLabels[sortedLabels.length-1]
                      // });
                  }

                  // 更新所有图表（使用确保正确排序的数据）
                  // 创建一个包含排序后数据的对象，与filterDataByTimeRange返回的格式相同
                  const sortedData = {
                      filteredLabels: sortedLabels,
                      filteredPrices: sortedPrices,
                      startIndex: filteredData.startIndex
                  };

                  // 更新所有图表
                  updateAllCharts(sortedData);

                  // 清除预测数据
                  closingPriceChart.data.datasets[1].data = [];
                  closingPriceChart.update();

                  // 更新数据表格
                  updateDataTable(chartData);

                  // 更新价格预测卡片
                  updatePricePredictionCards();

                  // 自动触发预测，确保使用最新数据
                  console.log("编辑数据后自动触发预测");
                  // 确保使用最新数据进行预测
                  setTimeout(() => {
                      console.log("执行延迟预测，确保使用最新数据");
                      // 强制刷新页面，确保使用最新数据
                      window.location.reload();
                  }, 1000); // 添加1秒延迟，确保数据已更新

                  // 显示成功消息
                  showNotification('数据编辑成功，图表和预测已更新', 'success');
              }
          } else {
              // 显示错误消息
              showNotification('编辑失败: ' + (data.error || '未知错误'), 'danger');
          }
      } catch (error) {
          // console.error('编辑数据时出错:', error);
          showNotification('编辑失败: ' + error.message, 'danger');
      }
  });

  // 删除数据按钮点击事件
  document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
      // 获取日期
      const deleteDateInput = document.getElementById('deleteDate').value;

      // 验证数据
      if (!deleteDateInput) {
          showNotification('删除日期是必填字段', 'danger');
          return;
      }

      try {
          // 尝试标准化日期格式（YYYY-MM-DD）
          let deleteDate = deleteDateInput;
          try {
              // 尝试解析日期并格式化为YYYY-MM-DD
              const dateObj = new Date(deleteDateInput);
              if (!isNaN(dateObj.getTime())) {
                  deleteDate = dateObj.toISOString().split('T')[0];
                  console.log(`日期已标准化: ${deleteDateInput} -> ${deleteDate}`);
              }
          } catch (e) {
              console.warn(`无法标准化日期: ${deleteDateInput}`, e);
              // 继续使用原始输入
          }

          // 显示加载状态
          showNotification('正在删除数据...', 'info');

          // 发送删除请求
          const response = await fetch('/viz/api/delete', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'Cache-Control': 'no-cache, no-store, must-revalidate',
                  'Pragma': 'no-cache',
                  'Expires': '0',
                  'X-Requested-With': 'XMLHttpRequest',
                  'X-Timestamp': new Date().getTime()
              },
              body: JSON.stringify({
                  date: deleteDate
              })
          });

          // 先获取响应文本，然后尝试解析为JSON
          const responseText = await response.text();
          let data;
          try {
              data = JSON.parse(responseText);
          } catch (parseError) {
              console.error("无法解析响应为JSON:", parseError);
              console.log("原始响应:", responseText);
              throw new Error(`解析响应失败: ${responseText.substring(0, 100)}${responseText.length > 100 ? '...' : ''}`);
          }

          if (data.success) {
              // 关闭模态框
              const modal = bootstrap.Modal.getInstance(document.getElementById('deleteDataModal'));
              if (modal) {
                  modal.hide();
              }

              // 更新图表数据
              if (data.chart_data) {
                  // 更新全局数据
                  chartData = data.chart_data;
                  labels = data.chart_data.labels;
                  closingPrices = data.chart_data.closing_prices;

                  // 更新显示的总数据条数
                  const countDisplay = document.getElementById('dataCountDisplay');
                  if (countDisplay) {
                      // 计算实际的记录数
                      const totalRecords = chartData.labels ? chartData.labels.length : 0;
                      countDisplay.textContent = `只显示前5条，共 ${totalRecords} 条`;
                  }

                  // 根据时间范围过滤数据
                  const timeRange = document.getElementById('timeRangeSelect').value;
                  const filteredData = filterDataByTimeRange(timeRange);

                  // 更新所有图表
                  updateAllCharts(filteredData);

                  // 清除预测数据
                  closingPriceChart.data.datasets[1].data = [];
                  closingPriceChart.update();

                  // 更新数据表格
                  updateDataTable(chartData);

                  // 更新价格预测卡片
                  updatePricePredictionCards();

                  // 自动触发预测
                  console.log("删除数据后自动触发预测");
                  // 确保使用最新数据进行预测
                  setTimeout(() => {
                      console.log("执行延迟预测，确保使用最新数据");
                      // 强制刷新页面，确保使用最新数据
                      window.location.reload();
                  }, 1000); // 添加1秒延迟，确保数据已更新

                  // 显示成功消息
                  showNotification(data.message + '，图表和预测已使用新数据更新', 'success');
              }
          } else {
              // 检查是否有最接近的日期建议
              if (data.closest_dates && data.closest_dates.length > 0) {
                  // 创建一个包含建议日期的提示消息
                  let errorMsg = data.error || '未找到指定日期的数据';

                  // 创建一个包含建议日期的下拉菜单
                  let suggestionsHtml = '<div class="mt-2"><select id="suggestedDates" class="form-select form-select-sm">';
                  data.closest_dates.forEach(date => {
                      suggestionsHtml += `<option value="${date}">${date}</option>`;
                  });
                  suggestionsHtml += '</select>';
                  suggestionsHtml += '<button id="useSuggestedDate" class="btn btn-sm btn-primary mt-2">使用此日期</button></div>';

                  // 显示错误消息和建议
                  showNotification(errorMsg + suggestionsHtml, 'warning', 0); // 0表示不自动关闭

                  // 添加使用建议日期的点击事件
                  document.getElementById('useSuggestedDate').addEventListener('click', function() {
                      const selectedDate = document.getElementById('suggestedDates').value;
                      document.getElementById('deleteDate').value = selectedDate;
                      // 关闭当前通知
                      document.querySelector('.toast.show .btn-close').click();
                      // 模拟点击删除按钮
                      document.getElementById('confirmDeleteBtn').click();
                  });
              } else {
                  // 显示普通错误消息
                  showNotification('删除失败: ' + (data.error || '未知错误'), 'danger');
              }
          }
      } catch (error) {
          // console.error('删除数据时出错:', error);
          showNotification('删除失败: ' + error.message, 'danger');
      }
  });

  // 更新数据表格函数
  function updateDataTable(chartData, startDate = null, endDate = null) {
      if (!chartData || !chartData.labels || !chartData.closing_prices) {
          // console.error('无法更新数据表格：数据无效');
          return;
      }

      // 获取表格元素
      const tableBody = document.querySelector('#dataTable tbody');
      if (!tableBody) {
          // console.error('无法找到数据表格的tbody元素');
          return;
      }

      // 清空表格
      tableBody.innerHTML = '';

      // 每页显示的记录数
      const pageSize = 5;

      // 根据日期范围过滤数据
      let filteredIndices = [];

      if (startDate && endDate) {
          // 将字符串日期转换为Date对象进行比较
          const start = new Date(startDate);
          const end = new Date(endDate);

          // 过滤符合日期范围的数据索引
          for (let i = 0; i < chartData.labels.length; i++) {
              const currentDate = new Date(chartData.labels[i]);
              if (currentDate >= start && currentDate <= end) {
                  filteredIndices.push(i);
              }
          }
      } else {
          // 如果没有指定日期范围，使用所有数据
          for (let i = 0; i < chartData.labels.length; i++) {
              filteredIndices.push(i);
          }
      }

      // 总记录数（过滤后）
      const totalRecords = filteredIndices.length;

      // 总页数
      const totalPages = Math.ceil(totalRecords / pageSize);

      // 当前页码（默认为第1页）
      let currentPage = 1;

      // 更新分页信息
      function updatePagination() {
          // 更新显示信息
          const infoElement = document.querySelector('.text-muted');
          if (infoElement) {
              if (currentPage === 1) {
                  // 如果是第一页，显示"只显示前5条，共X条"
                  const displayCount = Math.min(pageSize, totalRecords);
                  infoElement.textContent = `只显示前${displayCount}条，共 ${totalRecords} 条`;
              } else {
                  // 其他页面显示页码范围和总条数
                  const startRecord = (currentPage - 1) * pageSize + 1;
                  const endRecord = Math.min(currentPage * pageSize, totalRecords);
                  infoElement.textContent = `${startRecord}-${endRecord}条，共 ${totalRecords} 条`;
              }
          }

          // 更新分页按钮
          const pagination = document.querySelector('.pagination');
          if (pagination) {
              pagination.innerHTML = '';

              // 上一页按钮
              const prevItem = document.createElement('li');
              prevItem.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
              const prevLink = document.createElement('a');
              prevLink.className = 'page-link';
              prevLink.href = '#';
              prevLink.textContent = '上一页';
              prevLink.addEventListener('click', function(e) {
                  e.preventDefault();
                  if (currentPage > 1) {
                      currentPage--;
                      renderTablePage();
                      updatePagination();
                      addRowClickHandlers();
                  }
              });
              prevItem.appendChild(prevLink);
              pagination.appendChild(prevItem);

              // 页码按钮
              const maxPageButtons = 5; // 最多显示的页码按钮数
              const startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
              const endPage = Math.min(totalPages, startPage + maxPageButtons - 1);

              for (let i = startPage; i <= endPage; i++) {
                  const pageItem = document.createElement('li');
                  pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
                  const pageLink = document.createElement('a');
                  pageLink.className = 'page-link';
                  pageLink.href = '#';
                  pageLink.textContent = i;
                  pageLink.addEventListener('click', function(e) {
                      e.preventDefault();
                      currentPage = i;
                      renderTablePage();
                      updatePagination();
                      addRowClickHandlers();
                  });
                  pageItem.appendChild(pageLink);
                  pagination.appendChild(pageItem);
              }

              // 下一页按钮
              const nextItem = document.createElement('li');
              nextItem.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
              const nextLink = document.createElement('a');
              nextLink.className = 'page-link';
              nextLink.href = '#';
              nextLink.textContent = '下一页';
              nextLink.addEventListener('click', function(e) {
                  e.preventDefault();
                  if (currentPage < totalPages) {
                      currentPage++;
                      renderTablePage();
                      updatePagination();
                      addRowClickHandlers();
                  }
              });
              nextItem.appendChild(nextLink);
              pagination.appendChild(nextItem);
          }
      }

      // 渲染当前页的数据
      function renderTablePage() {
          // 清空表格
          tableBody.innerHTML = '';

          // 计算当前页的起始和结束索引
          const startIndex = (currentPage - 1) * pageSize;
          const endIndex = Math.min(startIndex + pageSize, totalRecords);

          // 反向遍历，使最新的数据显示在前面
          for (let i = totalRecords - startIndex - 1; i >= totalRecords - endIndex; i--) {
              if (i < 0) break;

              // 获取过滤后的数据索引
              const dataIndex = filteredIndices[i];
              if (dataIndex === undefined) continue;

              const row = document.createElement('tr');

              // 添加基本样式类，但不添加可点击样式
              row.classList.add('table-row-hover');

              // 日期
              const dateCell = document.createElement('td');
              dateCell.textContent = chartData.labels[dataIndex];
              row.appendChild(dateCell);

              // 开盘价
              const openCell = document.createElement('td');
              if (chartData.opening_prices && chartData.opening_prices[dataIndex] !== undefined) {
                  openCell.textContent = chartData.opening_prices[dataIndex].toLocaleString();
              }
              row.appendChild(openCell);

              // 最高价
              const highCell = document.createElement('td');
              if (chartData.high_prices && chartData.high_prices[dataIndex] !== undefined) {
                  highCell.textContent = chartData.high_prices[dataIndex].toLocaleString();
              }
              row.appendChild(highCell);

              // 最低价
              const lowCell = document.createElement('td');
              if (chartData.low_prices && chartData.low_prices[dataIndex] !== undefined) {
                  lowCell.textContent = chartData.low_prices[dataIndex].toLocaleString();
              }
              row.appendChild(lowCell);

              // 收盘价
              const closeCell = document.createElement('td');
              if (chartData.closing_prices[dataIndex] !== undefined) {
                  closeCell.textContent = chartData.closing_prices[dataIndex].toLocaleString();
              }
              row.appendChild(closeCell);

              // 成交量
              const volumeCell = document.createElement('td');
              if (chartData.volumes && chartData.volumes[dataIndex] !== undefined) {
                  volumeCell.textContent = chartData.volumes[dataIndex].toLocaleString();
              }
              row.appendChild(volumeCell);

              // 涨跌幅
              const changeCell = document.createElement('td');
              if (dataIndex > 0 && chartData.closing_prices[dataIndex] !== undefined && chartData.closing_prices[dataIndex-1] !== undefined) {
                  // 标准涨跌幅计算公式：(当日收盘价 - 前一日收盘价) / 前一日收盘价 × 100%
                  const change = ((chartData.closing_prices[dataIndex] - chartData.closing_prices[dataIndex-1]) / chartData.closing_prices[dataIndex-1] * 100).toFixed(2);
                  if (change > 0) {
                      changeCell.className = 'text-success';
                      changeCell.textContent = `+${change}%`;
                  } else if (change < 0) {
                      changeCell.className = 'text-danger';
                      changeCell.textContent = `${change}%`;
                  } else {
                      changeCell.className = 'text-muted';
                      changeCell.textContent = '0.00%';
                  }
              }
              row.appendChild(changeCell);

              tableBody.appendChild(row);
          }
      }

      // 初始渲染
      renderTablePage();
      updatePagination();

      // 添加行点击事件处理
      addRowClickHandlers();
  }

  // 增加数据功能
  document.getElementById('appendDataBtn').addEventListener('click', function() {
      // 获取表单和文件
      const form = document.getElementById('appendDataForm');
      const fileInput = document.getElementById('appendDataFile');

      // 检查是否选择了文件
      if (!fileInput.files || fileInput.files.length === 0) {
          alert('请选择要上传的CSV文件');
          return;
      }

      // 检查文件类型
      const file = fileInput.files[0];
      if (!file.name.toLowerCase().endsWith('.csv')) {
          alert('请选择CSV格式的文件');
          return;
      }

      // 创建FormData对象
      const formData = new FormData();
      formData.append('file', file);

      // 显示上传状态
      const appendStatus = document.getElementById('appendStatus');
      const appendProgressBar = document.getElementById('appendProgressBar');
      const appendStatusText = document.getElementById('appendStatusText');

      appendStatus.classList.remove('d-none');
      appendProgressBar.style.width = '0%';
      appendStatusText.textContent = '准备上传...';

      // 禁用上传按钮
      const appendBtn = document.getElementById('appendDataBtn');
      appendBtn.disabled = true;

      // 发送请求
      fetch('/viz/api/append', {
          method: 'POST',
          body: formData
      })
      .then(response => {
          appendProgressBar.style.width = '100%';

          if (!response.ok) {
              if (response.status === 500) {
                  // 尝试解析错误消息
                  return response.json().then(data => {
                      throw new Error(data.error || `上传失败: ${response.status} ${response.statusText}`);
                  }).catch(err => {
                      // 如果JSON解析失败，使用原始错误
                      throw new Error(`上传失败: ${response.status} ${response.statusText}`);
                  });
              } else {
                  throw new Error(`上传失败: ${response.status} ${response.statusText}`);
              }
          }

          appendStatusText.textContent = '上传成功，正在处理数据...';

          // 安全地解析JSON
          return response.text().then(text => {
              try {
                  // 尝试解析JSON
                  return JSON.parse(text);
              } catch (e) {
                  throw new Error('服务器返回的数据格式无效');
              }
          });
      })
      .then(data => {
          if (data.success) {
              // 上传成功
              const fileName = document.getElementById('appendDataFile').files[0].name;
              let statusMessage = `文件 ${fileName} 上传成功`;

              // 添加记录数信息（如果可用）
              if (data.added_rows !== undefined && data.total_rows !== undefined) {
                  statusMessage += `，共添加 ${data.added_rows} 条记录，总计 ${data.total_rows} 条记录`;
              } else if (data.rows !== undefined) {
                  statusMessage += `，共 ${data.rows} 条记录`;
              }

              // 如果有跳过的日期，显示相关信息
              if (data.skipped_dates && data.skipped_dates.length > 0) {
                  statusMessage += `，跳过了 ${data.skipped_dates.length} 条重复日期的记录`;
              }

              appendStatusText.textContent = statusMessage;

              // 更新图表数据
              if (data.chart_data) {
                  // 更新全局数据
                  chartData = data.chart_data;
                  labels = data.chart_data.labels;
                  closingPrices = data.chart_data.closing_prices;

                  // 更新显示的总数据条数
                  const countDisplay = document.getElementById('dataCountDisplay');
                  if (countDisplay) {
                      countDisplay.textContent = `只显示前5条，共 ${data.total_rows} 条`;
                  }

                  // 根据时间范围过滤数据
                  const timeRange = document.getElementById('timeRangeSelect').value;
                  const filteredData = filterDataByTimeRange(timeRange);

                  // 更新所有图表
                  updateAllCharts(filteredData);

                  // 清除预测数据
                  closingPriceChart.data.datasets[1].data = [];
                  closingPriceChart.update();

                  // 更新数据表格
                  updateDataTable(chartData);

                  // 更新价格预测卡片
                  updatePricePredictionCards();

                  // 自动触发预测
                  console.log("增加数据文件后自动触发预测");
                  // 确保使用最新数据进行预测
                  setTimeout(() => {
                      document.getElementById('applyFiltersBtn').click();
                  }, 500); // 添加短暂延迟，确保数据已更新

                  // 显示成功消息
                  const fileName = document.getElementById('appendDataFile').files[0].name;
                  let notificationMessage = `文件 ${fileName} 添加成功，图表和预测已使用新数据更新`;

                  // 添加记录数信息（如果可用）
                  if (data.added_rows !== undefined) {
                      notificationMessage += `，添加了 ${data.added_rows} 条记录`;
                  }

                  // 如果有跳过的日期，显示相关信息
                  if (data.skipped_dates && data.skipped_dates.length > 0) {
                      notificationMessage += `，已跳过 ${data.skipped_dates.length} 条重复日期的记录`;
                  }
                  showNotification(notificationMessage, 'success');

                  // 关闭模态框
                  setTimeout(() => {
                      const modal = bootstrap.Modal.getInstance(document.getElementById('appendDataModal'));
                      if (modal) {
                          modal.hide();
                      }
                  }, 1500);
              }
          } else {
              // 上传失败
              appendStatusText.textContent = data.error || '添加失败';
              appendProgressBar.classList.remove('bg-primary');
              appendProgressBar.classList.add('bg-danger');

              // 特殊处理"数据重复"的错误消息
              if (data.error && data.error.includes('数据重复')) {
                  showNotification(data.error, 'warning');
              } else {
                  showNotification('添加失败: ' + (data.error || '未知错误'), 'danger');
              }
          }
      })
      .catch(error => {
          appendStatusText.textContent = `添加失败: ${error.message}`;
          appendProgressBar.classList.remove('bg-primary');
          appendProgressBar.classList.add('bg-danger');
          showNotification('添加失败: ' + error.message, 'danger');
      })
      .finally(() => {
          // 启用上传按钮
          appendBtn.disabled = false;
      });
  });

  // 增加数据功能已在上方实现

  // 删除了重复的事件监听器代码

  // 在删除模态框显示前设置当前日期
  $('#deleteDataModal').on('show.bs.modal', function () {
      const today = new Date();
      const formattedDate = today.toISOString().split('T')[0];
      document.getElementById('deleteDate').value = formattedDate;
      // 允许用户修改日期
      document.getElementById('deleteDate').removeAttribute('readonly');
  });



  // 在编辑数据模态框显示前设置当前日期并添加日期变更事件
  $('#editDataModal').on('show.bs.modal', function () {
      const today = new Date();
      const formattedDate = today.toISOString().split('T')[0];

      // 设置默认日期为今天
      const editDateInput = document.getElementById('editDate');
      editDateInput.value = formattedDate;

      // 保存当前编辑日期
      currentEditDate = formattedDate;

      // 清空其他字段
      document.getElementById('editOpen').value = '';
      document.getElementById('editHigh').value = '';
      document.getElementById('editLow').value = '';
      document.getElementById('editClose').value = '';
      document.getElementById('editVolume').value = '';

      // 尝试查找并填充当前日期的数据
      fillEditFormWithDateData(formattedDate);
  });

  // 只添加一次日期变更事件（在页面加载时）
  document.getElementById('editDate').addEventListener('change', function() {
      const selectedDate = this.value;
      currentEditDate = selectedDate;
      fillEditFormWithDateData(selectedDate);
  });

  // 根据日期填充编辑表单数据
  function fillEditFormWithDateData(date) {
      if (!chartData || !chartData.labels) return;

      // 查找日期对应的索引
      const dateIndex = chartData.labels.findIndex(label => label === date);

      if (dateIndex !== -1) {
          // 找到数据，填充表单
          document.getElementById('editOpen').value = chartData.opening_prices && chartData.opening_prices[dateIndex] !== undefined ?
              chartData.opening_prices[dateIndex] : '';
          document.getElementById('editHigh').value = chartData.high_prices && chartData.high_prices[dateIndex] !== undefined ?
              chartData.high_prices[dateIndex] : '';
          document.getElementById('editLow').value = chartData.low_prices && chartData.low_prices[dateIndex] !== undefined ?
              chartData.low_prices[dateIndex] : '';
          document.getElementById('editClose').value = chartData.closing_prices && chartData.closing_prices[dateIndex] !== undefined ?
              chartData.closing_prices[dateIndex] : '';
          document.getElementById('editVolume').value = chartData.volumes && chartData.volumes[dateIndex] !== undefined ?
              chartData.volumes[dateIndex] : '';

          showNotification(`已加载 ${date} 的数据`, 'success');
      } else {
          // 未找到数据，清空表单
          document.getElementById('editOpen').value = '';
          document.getElementById('editHigh').value = '';
          document.getElementById('editLow').value = '';
          document.getElementById('editClose').value = '';
          document.getElementById('editVolume').value = '';

          showNotification(`未找到 ${date} 的数据，请输入新数据`, 'warning');
      }
  }

  // 添加日期区间查询功能
  document.getElementById('queryDateRangeBtn').addEventListener('click', function() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      if (!startDate || !endDate) {
          showNotification('请选择开始日期和结束日期', 'warning');
          return;
      }

      if (new Date(startDate) > new Date(endDate)) {
          showNotification('开始日期不能晚于结束日期', 'warning');
          return;
      }

      // 使用日期范围更新数据表格
      updateDataTable(chartData, startDate, endDate);

      showNotification(`已显示 ${startDate} 至 ${endDate} 的数据`, 'success');
  });

  // 重置日期区间查询
  document.getElementById('resetDateRangeBtn').addEventListener('click', function() {
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';

      // 重置表格，显示所有数据
      updateDataTable(chartData);

      showNotification('已重置日期筛选，显示全部数据', 'info');
  });
</script>
{% endblock %}
