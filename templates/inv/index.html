{% extends 'base.html' %} {% block title %}库存记录 - 电商数据分析平台{%
endblock %} {% block head %}
<style>
  .inv-card {
    transition: all 0.3s ease;
    margin-bottom: 20px;
  }
  .inv-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  }
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  }
  .inv-card {
    border-left: 4px solid #007bff;
    transition: all 0.3s ease;
  }
  .inv-card:hover {
    background-color: #f8f9fa;
  }
  .inv-card.hot {
    border-left-color: #dc3545;
  }
  .inv-card.announcement {
    border-left-color: #ffc107;
  }

  .topic-stats {
    text-align: center;
    min-width: 60px;
  }
  .topic-badge {
    font-size: 0.7rem;
    padding: 2px 5px;
  }
  .last-reply {
    font-size: 0.85rem;
  }
</style>
{% endblock %} {% block content %}
<div class="container">
  <!--标题-->
  <div class="row mb-4">
    <div class="col-md-8">
      <h2><i class="bi bi-box-seam"></i> 库存记录</h2>
      <p class="lead">轻松记录库存，自动采购提醒</p>
    </div>
    <div class="col-md-4 text-end">
      <button
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#newInventoryModal"
      >
        <i class="bi bi-plus-circle"></i> 新建库存
      </button>
    </div>
  </div>

  <!-- 主页面 -->
  <div class="row">
    <div class="col-md-8 inv-list-container">
      <!-- 仓库卡片 -->
      {% if not inv_list %}
        <h5 class="mb-0"><i class="bi bi-bell"></i> 您还没有库存，快去新建一个吧</h5>
      {% endif %}
      {% for inv in inv_list %}
        {% set exp = inv.expiration_date %}
        <div class="card inv-card {% if exp and exp < today %}hot{% endif %} mb-3">
          <div class="row g-0">
            <!-- 左侧指标区 -->
            <div class="col-md-3 border-end p-3">
              <h5 class="card-title">{{ inv.name }}</h5>
              <p class="mb-1"><i class="bi bi-tags"></i> {{ inv.category }}</p>
              <p class="mb-1"><i class="bi bi-box-seam"></i> 库存: {{ inv.quantity }}/{{ inv.capacity }}</p>
              <p class="mb-0 text-muted">
                <i class="bi bi-calendar-event-fill"></i>
                {% if inv.expiration_date %}
                    {{ inv.expiration_date }}
                {% else %}
                    无期限
                {% endif %}
              </p>
            </div>
            <!-- 右侧操作区 -->
            <div class="col-md-9 p-3 d-flex flex-column justify-content-between">
              <div>
                <p class="mb-0"> 其它信息</p>
              </div>
              <div class="btn-group gap-2" role="group">
                <a href="{{ url_for('inv.detail', inv_id=inv.id) }}" class="btn btn-sm btn-primary">
                  <i class="bi bi-search"></i> 查看详情
                </a>
                <button class="btn btn-sm btn-warning" onclick="openStockInModal('{{ inv.id }}', '{{ inv.name }}')">
                  <i class="bi bi-box-arrow-in-down"></i> 入库
                </button>
                <button class="btn btn-sm btn-warning" onclick="openStockOutModal('{{ inv.id }}', '{{ inv.name }}')">
                  <i class="bi bi-box-arrow-up"></i> 出库
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteInventory('{{ inv.id }}')">
                  <i class="bi bi-trash"></i> 删除仓库
                </button>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}

      <!-- 分页 -->
      <div class="d-flex justify-content-between align-items-center mt-4">
        <div>
          <span class="text-muted inv-pagination-info"
            >显示 0 条，共 0 条</span
          >
        </div>
        <nav>
          <ul class="pagination pagination-sm inv-pagination">
            <!-- 分页按钮将由JavaScript动态生成 -->
          </ul>
        </nav>
      </div>
    </div>

    {% if inv_list %}
    <div class="col-md-4">
      <!-- 采购提醒 -->
      <div class="card mb-4">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="bi bi-bell"></i> 采购提醒</h5>
        </div>
        <div class="card-body">
          <h6 class="mb-0">库存不足，发出预警</h6>
          <hr class="my-2" />
          <ul class="list-group list-group-flush" id="alert-list">
            {% set ns = namespace(cnt=0) %}
            {% for inv in inv_list %}
              {% if inv.quantity < 0.2*inv.capacity and ns.cnt < 5 %}
                <li class="list-group-item">
                  <a
                    href="#"
                    target="_blank"
                    class="text-decoration-none"
                  > {{ inv.name }} <i class="bi bi-box-arrow-up-right small"></i>
                  </a>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="md-0"><i class="bi bi-tags"></i> {{ inv.category }}</span>
                    <span class="badge bg-danger">{{ inv.quantity }} / {{ inv.capacity }}</span>
                  </div>
                </li>
                {% set ns.cnt = ns.cnt + 1 %}
              {% endif %}
            {% endfor %}
            {% if ns.cnt == 0 %}
              <p class="mb-0">所有库存都很健康 :)</p>
            {% endif %}
          </ul>
        </div>
      </div>

      <!-- 危险库存 -->
      <div class="card mb-4">
        <div class="card-header bg-warning text-white">
          <h5 class="mb-0"><i class="bi bi-bar-chart"></i> 危险库存</h5>
        </div>
        <div class="card-body">
          <h6 class="mb-0">库存过期、库存不足</h6>
          <hr class="my-2" />
          <ul class="list-group">
            {% set ns = namespace(cnt=0) %}
            {% for inv in inv_list %}
              {% if ns.cnt < 5 %}
                {% set pct = (inv.quantity / inv.capacity * 100) if inv.capacity else 0 %}
                <li class="list-group-item">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>{{ inv.name }}</span>
                    <span>{{ inv.quantity }} / {{ inv.capacity }} ({{ pct|round(1) }}%)</span>
                    </div>
                  <div class="progress" style="height: 1rem;">
                    <div
                      class="progress-bar 
                        {% if pct < 33 %}
                          bg-danger
                        {% elif pct < 66 %}
                          bg-warning
                        {% else %}
                          bg-success
                        {% endif %}"
                      role="progressbar"
                      style="width: {{ pct }}%;"
                      aria-valuenow="{{ inv.quantity }}"
                      aria-valuemin="0"
                      aria-valuemax="{{ inv.capacity }}"
                    ></div>
                  </div>
                </li>
                {% set ns.cnt = ns.cnt + 1 %}
              {% endif %}
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- 仓库模态框 -->
<div
  class="modal fade"
  id="newInventoryModal"
  tabindex="-1"
  aria-labelledby="newInventory"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newInventory">新建仓库</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="newInventoryForm">
          <div class="mb-3">
            <label for="inventoryCategory" class="form-label">
              仓库类别 <span class="text-danger">*</span>
            </label>
            <input
              type="text"
              class="form-control"
              id="inventoryCategory"
              name="category"
              placeholder="食品、化妆品、电子产品、..."
              maxlength="10"
              required
            />
          </div>
          <div class="mb-3">
            <label for="inventoryTitle" class="form-label">
              仓库名称 <span class="text-danger">*</span>
            </label>
            <input
              type="text"
              class="form-control"
              id="inventoryTitle"
              name="title"
              placeholder="请输入仓库名称（1-8个字）"
              minlength="1"
              maxlength="8"
              required
            />
            <div class="form-text">名称应简明扼要，清晰表达仓库内容</div>
          </div>
          <div class="mb-3">
            <label for="inventoryCapacity" class="form-label">
              数量上限 <span class="text-danger">*</span>
            </label>
            <input
              type="text"
              class="form-control"
              id="inventoryCapacity"
              name="capacity"
              placeholder="例如：10000"
              required
            />
            <div class="form-text">
              根据自定单位来填写，例如：件、箱、吨等
            </div>
          </div>
          <div class="mb-3">
            <label for="inventoryExp" class="form-label">
              销毁日期
            </label>
            <input
              type="date"
              class="form-control"
              id="inventoryExp"
              name="expiration"
              min="{{ today }}"
            />
            <div class="form-text">
              如果未计划销毁仓库，请在日历中【清除】日期
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          取消
        </button>
        <button type="button" class="btn btn-primary" id="submitNewInventory">
          添加
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 入库模态框 -->
<div class="modal fade" id="stockInModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-box-arrow-in-down"></i> 入库操作</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="stockInForm">
          <input type="hidden" id="stockInId" name="inv_id">
          <div class="mb-3">
            <label class="form-label">仓库名称</label>
            <input type="text" class="form-control" id="stockInName" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">入库数量 <span class="text-danger">*</span></label>
            <input type="number" class="form-control" name="quantity" required min="1">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="submitStockIn()">确认入库</button>
      </div>
    </div>
  </div>
</div>

<!-- 出库模态框 -->
<div class="modal fade" id="stockOutModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-box-arrow-up"></i> 出库操作</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="stockOutForm">
          <input type="hidden" id="stockOutId" name="inv_id">
          <div class="mb-3">
            <label class="form-label">仓库名称</label>
            <input type="text" class="form-control" id="stockOutName" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">出库数量 <span class="text-danger">*</span></label>
            <input type="number" class="form-control" name="quantity" required min="1">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="submitStockOut()">确认出库</button>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script src="{{ url_for('static', filename='js/pagination.js') }}"></script>
<script>
  // 新建仓库
  document.addEventListener("DOMContentLoaded", function () {
    // 处理发布新主题表单提交
    const newInvForm = document.getElementById("newInventoryForm");
    const submitNewInvBtn = document.getElementById("submitNewInventory");

    // 处理表单提交
    submitNewInvBtn.addEventListener("click", function () {
      // 验证表单
      const category = document.getElementById("inventoryCategory").value.trim();
      const title = document.getElementById("inventoryTitle").value.trim();
      const capacity = document.getElementById("inventoryCapacity").value.trim();
      const expiration = document.getElementById("inventoryExp").value.trim();

      if (!category) {
        alert("请填写仓库类别");
        return;
      }

      if (!title || title.length < 1) {
        alert("名称不能为空，至少1个字符");
        return;
      }

      if (!capacity) {
        alert("请填写有效的数量上限");
        return;
      }

      // 创建FormData对象
      const formData = new FormData(newInventoryForm);

      // 显示加载状态
      submitNewInvBtn.disabled = true;
      submitNewInvBtn.innerHTML =
        '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 建立中...';

      // 发送AJAX请求
      fetch('{{ url_for("inv.create_inventory") }}', {
        method: "POST",
        body: formData,
      })
        .then((response) => response.json())
        .then((data) => {
          // 恢复按钮状态
          submitNewInvBtn.disabled = false;
          submitNewInvBtn.innerHTML = "创建仓库";

          if (data.success) {
            // 显示成功消息
            alert(data.message);

            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("newInventoryModal"),
            );
            modal.hide();

            // 刷新当前页面
            window.location.reload();
          } else {
            // 显示错误消息
            alert(data.message || "创建失败，请稍后重试");
          }
        })
        .catch((error) => {
          // 恢复按钮状态
          submitNewInvBtn.disabled = false;
          submitNewInvBtn.innerHTML = "创建仓库";

          // 显示错误消息
          alert("发布失败，请稍后重试");
          console.error("Error:", error);
        });
    });


    // 更新分页信息
    const invCards = document.querySelectorAll(".inv-card");
    const paginationInfo = document.querySelector(".inv-pagination-info");

    if (paginationInfo && invCards.length > 0) {
      paginationInfo.textContent = `显示 1-${invCards.length} 条，共 ${invCards.length} 条`;
    }

  });

// 删除仓库
function deleteInventory(invId) {
if (!confirm(`确定要删除仓库${invId}？此操作不可恢复。`)) {
  return;
}

fetch(`/inv/delete/${invId}`, {
  method: 'DELETE',
  headers: {
    'Content-Type': 'application/json',
  }
})
.then(response => response.json())
.then(data => {
  if (data.success) {
    alert('删除成功！');
    window.location.reload();
  } else {
    alert(data.message || '删除失败，请稍后重试');
  }
})
.catch(error => {
  console.error('Error:', error);
  alert('删除失败，请稍后重试');
});
}

function openStockInModal(invId, invName) {
  document.getElementById('stockInId').value = invId;
  document.getElementById('stockInName').value = invName;
  new bootstrap.Modal(document.getElementById('stockInModal')).show();
}

function submitStockIn() {
  const form = document.getElementById('stockInForm');
  const formData = new FormData(form);
  
  fetch(`/inv/stock/${formData.get('inv_id')}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      operation: 'in',
      quantity: parseInt(formData.get('quantity'))
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('入库成功！');
      window.location.reload();
    } else {
      alert(data.message || '操作失败，请重试');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('操作失败，请重试');
  });
}

function openStockOutModal(invId, invName) {
  document.getElementById('stockOutId').value = invId;
  document.getElementById('stockOutName').value = invName;
  new bootstrap.Modal(document.getElementById('stockOutModal')).show();
}

function submitStockOut() {
  const form = document.getElementById('stockOutForm');
  const formData = new FormData(form);
  
  fetch(`/inv/stock/${formData.get('inv_id')}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      operation: 'out',
      quantity: parseInt(formData.get('quantity'))
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('出库成功！');
      window.location.reload();
    } else {
      alert(data.message || '操作失败，请重试');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('操作失败，请重试');
  });
}
</script>

{% endblock %}